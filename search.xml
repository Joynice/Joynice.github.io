<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Flask-Sqlalchemy中使用JSON字段</title>
    <url>/2019/12/23/Flask-Sqlalchemy%E4%B8%AD%E4%BD%BF%E7%94%A8JSON%E5%AD%97%E6%AE%B5/</url>
    <content><![CDATA[<p>Mysql从5.7版本后支持Json字段，本片文章记录Flask-Sqlalchemy如何对于Json字段进行增删改查操作</p>
<a id="more"></a>
<blockquote>
<p>项目中的字段无法确定，动态变化时使用。<br>也可以使用text、varchar来代替，但是text、varchar是不支持搜索的，并且不支持局部更新，只能更改全部字段，增加了i/o操作，不利于性能。</p>
</blockquote>
<p>定义一个<code>User</code>类</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name= db.Column(db.String(<span class="number">32</span>), comment=<span class="string">'姓名'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    extra = db.Column(db.JSON, comment=<span class="string">'扩展字段'</span>)</span></pre></td></tr></table></figure>
<h3 id="0x01-添加数据"><a href="#0x01-添加数据" class="headerlink" title="0x01 添加数据"></a>0x01 添加数据</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user = User(name = <span class="string">'张三'</span>, extra = dict(age=<span class="number">18</span>, gender = <span class="number">1</span>, weght = <span class="number">70</span>kg))) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.add(user)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure>
<h3 id="0x02-更新Json数据"><a href="#0x02-更新Json数据" class="headerlink" title="0x02 更新Json数据"></a>0x02 更新Json数据</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm.attributes <span class="keyword">import</span> flag_modified </span></pre></td></tr><tr><td class="code"><pre><span class="line">user.extra.update(dict(birthday=<span class="number">1998</span><span class="number">-12</span><span class="number">-12</span>))) </span></pre></td></tr><tr><td class="code"><pre><span class="line">flag_modified(user, <span class="string">'extra'</span>) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.add(user) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure>

<h3 id="0x03-删除Json字段"><a href="#0x03-删除Json字段" class="headerlink" title="0x03 删除Json字段"></a>0x03 删除Json字段</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user.extra.pop(<span class="string">'birthday'</span>) </span></pre></td></tr><tr><td class="code"><pre><span class="line">flag_modified(user, <span class="string">'extra'</span>) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.add(user) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure>
<h3 id="0x04-查询Json字段"><a href="#0x04-查询Json字段" class="headerlink" title="0x04 查询Json字段"></a>0x04 查询Json字段</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> cast, type_coerce</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> String, JSON</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 首先是针对单一数字、字符串时</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">User.query.filter(User.extra[<span class="string">'age'</span>] == <span class="number">18</span>, User.extra[<span class="string">'weght'</span>] == <span class="string">'70kg'</span>).first()</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 另一种特殊情况时,查询条件是一个对象时： </span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 先增加一组数据： </span></span></pre></td></tr><tr><td class="code"><pre><span class="line">user.extra.update(dict(info=dict(address=<span class="string">'北京市'</span>))) </span></pre></td></tr><tr><td class="code"><pre><span class="line">flag_modified(user, <span class="string">'extra'</span>) </span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit() </span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 查询整个info时： </span></span></pre></td></tr><tr><td class="code"><pre><span class="line">User.query.filter(cast(User.extra[<span class="string">'info'</span>], String) == json.dumps(&#123;<span class="string">'address'</span>:<span class="string">'北京市'</span>&#125;)).first() </span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># or</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">User.query.filter(cast(User.extra[<span class="string">'info'</span>], String) == type_coerce(&#123;<span class="string">"address"</span>: <span class="string">"北京市"</span>&#125;, JSON)).first()</span></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Flask-Sqlalchemy</tag>
      </tags>
  </entry>
  <entry>
    <title>Clipboard使用</title>
    <url>/2019/12/23/clipboard%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>在开发<a href="https://github.com/Joynice/PicGo_Web" target="_blank" rel="noopener">PicGo_Web</a>时，点击Copy，将绑定的url复制到粘贴板中。</p>
<a id="more"></a>

<p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/copy.JPG" alt="Copy"><br>找到各种插件，最后选择使用<code>Clipboard</code>来实现这个功能</p>
<h3 id="0x01-引入Clipboard"><a href="#0x01-引入Clipboard" class="headerlink" title="0x01 引入Clipboard"></a>0x01 引入Clipboard</h3><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://www.jq22.com/demo/clipboard.js-master201703170013/dist/clipboard.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></pre></td></tr></table></figure>
<h3 id="0x02-指定内容"><a href="#0x02-指定内容" class="headerlink" title="0x02 指定内容"></a>0x02 指定内容</h3><p>使用<code>data-clipboard-text</code>指定copy内容</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"layui-btn layui-btn-xs layui-btn-radius layui-btn-warm copy"</span> <span class="attr">id</span>=<span class="string">"copy"</span> <span class="attr">data-clipboard-text</span>=<span class="string">"&#123;&#123; image.link &#125;&#125;"</span>&gt;</span>copy</span></pre></td></tr></table></figure>

<h3 id="0x03-绑定元素"><a href="#0x03-绑定元素" class="headerlink" title="0x03 绑定元素"></a>0x03 绑定元素</h3><p>当点击到<code>copy</code>类的时候进行拷贝操作</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;    <span class="comment">//copy链接</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">var</span> clipboard = <span class="keyword">new</span> Clipboard(<span class="string">'.copy'</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    clipboard.on(<span class="string">'success'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        layer.msg(<span class="string">"已拷贝到粘贴版"</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    clipboard.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="built_in">console</span>.log(e);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>前端</tag>
        <tag>Clipboard</tag>
      </tags>
  </entry>
  <entry>
    <title>python操作github</title>
    <url>/2019/12/23/python%E6%93%8D%E4%BD%9Cgithub/</url>
    <content><![CDATA[<p>在写<a href="https://github.com/Joynice/PicGo_Web" target="_blank" rel="noopener">PicGo_Web</a>时，需要向Github上传图片和删除图片，这里记录下如何操作。</p>
<a id="more"></a>
<p>据我了解，能够操作Github的库有两个：</p>
<ul>
<li>PyGithub</li>
<li>GitPython</li>
</ul>
<p>前者通过Github Api进行操作操作，或者通过调用本地Git进行操作，各有优缺点，本次使用前者进行操作。</p>
<h3 id="0x01-配置"><a href="#0x01-配置" class="headerlink" title="0x01 配置"></a>0x01 配置</h3><p>使用<code>PyGithub</code>在实例<code>Github</code>类的时候需要验证github用户名和密码，或者验证Github Token，所以需要配置username, password 两个参数。</p>
<h3 id="0x02-上传图片"><a href="#0x02-上传图片" class="headerlink" title="0x02 上传图片"></a>0x02 上传图片</h3><p>上传文件需要指定上传远端的路径如(img/aaa.png)，commit信息，上传内容，以及上传分支,其中上传内容需要读取图片内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_file</span><span class="params">(self, filname, content)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    repo = self.__create_repo()</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> isinstance(repo, str):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, repo</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">try</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            repo.create_file(path=filname, message=<span class="string">'add &#123;&#125;'</span>.format(filname), content=content, branch=self.branch) <span class="comment">#上传路径,commit信息,上传内容,上传分支</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">1</span>, <span class="string">'https://raw.githubusercontent.com/&#123;&#125;/&#123;&#125;/&#123;&#125;/&#123;&#125;'</span>.format(self.username, self.repository, self.branch, filname)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, <span class="string">'添加失败'</span></span></pre></td></tr></table></figure>
<h3 id="0x03-删除图片"><a href="#0x03-删除图片" class="headerlink" title="0x03 删除图片"></a>0x03 删除图片</h3><p>删除图片时候需要现获取图片的<code>sha</code>值，再进行删除</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span><span class="params">(self, filename)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    repo = self.__create_repo()</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> isinstance(repo, str):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, repo</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        contents = repo.get_contents(filename)  <span class="comment">#获取文件内容</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> contents:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            repo.delete_file(contents.path, <span class="string">"remove &#123;&#125;"</span>.format(filename), contents.sha, branch=self.branch)</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">1</span>, <span class="string">'删除成功'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, <span class="string">'删除失败'</span></span></pre></td></tr></table></figure>
<h3 id="0x04-源代码"><a href="#0x04-源代码" class="headerlink" title="0x04 源代码"></a>0x04 源代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">__author__ = <span class="string">'Joynice'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> github <span class="keyword">import</span> Github</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> config</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GithubTools</span><span class="params">(Github)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, username=config.GITHUB_USERNAME, password=config.GITHUB_PASSWORD, repository=config.REPOSITORIES, path=config.PATH, branch=config.BRANCH)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        self.username = username</span></pre></td></tr><tr><td class="code"><pre><span class="line">        self.password = password</span></pre></td></tr><tr><td class="code"><pre><span class="line">        self.repository = repository</span></pre></td></tr><tr><td class="code"><pre><span class="line">        self.path = path</span></pre></td></tr><tr><td class="code"><pre><span class="line">        self.branch = branch</span></pre></td></tr><tr><td class="code"><pre><span class="line">        Github.__init__(self, username, password)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__create_repo</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">try</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            repo = self.get_repo(<span class="string">'&#123;&#125;/&#123;&#125;'</span>.format(self.username, self.repository))</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> repo</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">except</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="string">'连接Github API失败，请重新测试'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_file</span><span class="params">(self, filname, content)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        repo = self.__create_repo()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> isinstance(repo, str):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, repo</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">try</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                repo.create_file(path=filname, message=<span class="string">'add &#123;&#125;'</span>.format(filname), content=content, branch=self.branch) <span class="comment">#上传路径,commit信息,上传内容,上传分支</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="number">1</span>, <span class="string">'https://raw.githubusercontent.com/&#123;&#125;/&#123;&#125;/&#123;&#125;/&#123;&#125;'</span>.format(self.username, self.repository, self.branch, filname)</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="number">0</span>, <span class="string">'添加失败'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_file</span><span class="params">(self, filename)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        repo = self.__create_repo()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> isinstance(repo, str):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">0</span>, repo</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            contents = repo.get_contents(filename)  <span class="comment">#获取文件内容</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">if</span> contents:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                repo.delete_file(contents.path, <span class="string">"remove &#123;&#125;"</span>.format(filename), contents.sha, branch=self.branch)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="number">1</span>, <span class="string">'删除成功'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="number">0</span>, <span class="string">'删除失败'</span></span></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Github</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>PicGo_Web打造专属图床</title>
    <url>/2019/12/19/PicGo-Web%E6%89%93%E9%80%A0%E4%B8%93%E5%B1%9E%E5%9B%BE%E5%BA%8A/</url>
    <content><![CDATA[<p>PicGo_Web打造专属图床</p>
<a id="more"></a>
<h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2><p>忙里抽闲写了这个图床工具，灵感来自于<a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">PicGo</a>,在使用过程中发现这个工具的强大<br>于是模仿写了个<code>Web</code>端的工具，方便自己搭建一个简易的图床。</p>
<h2 id="应用说明"><a href="#应用说明" class="headerlink" title="应用说明"></a>应用说明</h2><p>PicGo_Web目前支持</p>
<ul>
<li>Github</li>
<li>个人服务器</li>
</ul>
<p><em>目前支持的方式比较少，但是也是最稳定的两个图床选择</em></p>
<p><code>Github</code>：虽然国内访问慢，但是可以保证图片存在的永久性，插个话“Github都准备把全球开源代码保存在北极，至少保存1000年，那<br>岂不是子子孙孙都能找到你当前上传的图片，哈哈”。这个图床的设计主要是方便那些没有个人服务器的小伙伴们，在github创建个仓库，就可以<br>作为图床，保存你上传的图片。</p>
<p><code>个人服务器</code>：如果你不满足于github的速度，你可以选择个人服务器，但是服务器到期的时候，图床也就失效了，个人还是觉得github还是不错的，<br>白嫖，嘻嘻</p>
<h2 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h2><p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/picweb.JPG" alt="界面"></p>
<p>本程序<code>Flask</code>框架开发，前端使用<code>layui</code>，对于没有美感的我，可以说前端设计真是对<code>layui</code>的侮辱。</p>
<p><strong>环境：python3.0+</strong></p>
<h4 id="安装步骤："><a href="#安装步骤：" class="headerlink" title="安装步骤："></a>安装步骤：</h4><p><strong>0x01 git clone</strong><br> <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;Joynice&#x2F;PicGo_Web.git</span></pre></td></tr></table></figure></p>
<p><strong>0x02 安装依赖</strong></p>
<p>切到项目根目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install -r requirements.txt</span></pre></td></tr></table></figure>

<p><strong>0x03 数据库迁移</strong><br>切到项目根目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python manages.py db init</span></pre></td></tr><tr><td class="code"><pre><span class="line">python manages.py db migrate</span></pre></td></tr><tr><td class="code"><pre><span class="line">python manages.py db upgrade</span></pre></td></tr></table></figure>

<p><strong>0x04 修改config中配置</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">STORE_TYPE = <span class="string">'github'</span> <span class="comment">#存储方式（github or server）</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment">#github 配置</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">GITHUB_USERNAME = <span class="string">'xxx'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">GITHUB_PASSWORD = <span class="string">'xxx'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">REPOSITORIES = <span class="string">'xxx'</span>  <span class="comment">#需要提前创建，仓库名</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">BRANCH = <span class="string">'master'</span> <span class="comment">#分支</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">PATH = <span class="string">'xxx'</span> <span class="comment"># 存储路径</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># server 配置</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">LOCAL_STORAGE_PATH = os.path.join(os.getcwd(),<span class="string">'static'</span>,<span class="string">'images'</span>) <span class="comment">#默认存储到项目static/images文件夹下</span></span></pre></td></tr></table></figure>

<p><strong>0x05 运行</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python run.py</span></pre></td></tr></table></figure>
<p>如果有bug，请及时issues，定会及时回复</p>
<blockquote>
<p>以上步骤可以启动程序，如果你想要高性能部署(gunicorn+nginx)，参照文章:<a href="http://lr.dropsec.xyz/2019/12/14/Gunicorn-Nginx%E9%83%A8%E7%BD%B2Flask%E9%A1%B9%E7%9B%AE/">Gunicorn+Nginx部署Flask项目</a></p>
</blockquote>
<h2 id="贡献"><a href="#贡献" class="headerlink" title="贡献"></a>贡献</h2><p>如果你觉得这个工具，还可以，不妨赏点:</p>
<p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/wx.JPG" alt="微信"><br><img src="https://raw.githubusercontent.com/Joynice/image/master/img/zfb.JPG" alt="支付宝"></p>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>记录Flask-Sqlalchemy使用过的查询</title>
    <url>/2019/12/16/%E8%AE%B0%E5%BD%95Flask-Sqlalchemy%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<p>在使用Flask开发的时候，用到Flask-Sqlalchemy进行数据库操作，<code>查</code>作为数据库操作重要的部分，查询语句的设计直接关系到网站性能，真实体验到<code>查</code>操作的重要性。</p>
<a id="more"></a>

<p>本片文章主要记录Flask-Sqlalchemy查询操作，也是开发工作中使用过的在此做个记录，先定义多对多的关系，方便举栗子，这是开发中的使用的例子，也可以理解成一般的多对多关系。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tags</span><span class="params">(db.Model)</span>:</span>  <span class="comment">#标签表</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    漏洞的标签：id、名称、创建时间</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    __tablename__ = <span class="string">'t_tags'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    name = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">True</span>, comment=<span class="string">'漏洞标签名称'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    create_time = db.Column(db.DateTime, default=datetime.datetime.now, comment=<span class="string">'加入时间'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    vuls = db.relationship(<span class="string">'Vuls'</span>, secondary=vul_tag, backref=<span class="string">'tags'</span>)  <span class="comment"># 设置关系，通过中间表`t_vul_tag`实现</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vuls</span><span class="params">(db.Model)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    靶场漏洞库</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    __tablename__ = <span class="string">'t_vuls'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>) <span class="comment">#uuid</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name = db.Column(db.String(<span class="number">255</span>), nullable=<span class="literal">True</span>, comment=<span class="string">'漏洞名称'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    create_time = db.Column(db.DateTime, default=datetime.datetime.now, comment=<span class="string">'加入时间'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    vul_tag = db.Table(  <span class="comment">#中间表，表名`t_vul_tag`</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'t_vul_tag'</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.Column(<span class="string">'t_vul_id'</span>, db.Integer, db.ForeignKey(<span class="string">'t_vuls.id'</span>), primary_key=<span class="literal">True</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.Column(<span class="string">'t_tag_id'</span>, db.Integer, db.ForeignKey(<span class="string">'t_tags.id'</span>), primary_key=<span class="literal">True</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">)</span></pre></td></tr></table></figure>

<h3 id="0x01-简单操作"><a href="#0x01-简单操作" class="headerlink" title="0x01 简单操作"></a>0x01 简单操作</h3><p><strong>普通查询</strong></p>
<ul>
<li>根据主键(id)获取某一标签  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tag = Tags.query.get(id)</span></pre></td></tr></table></figure></li>
<li>获取所有的标签  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.all()</span></pre></td></tr></table></figure></li>
<li>根据非主键获取某一标签(name)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tag = Tags.query.filter(Tags.name==<span class="string">'xxx'</span>).first()</span></pre></td></tr><tr><td class="code"><pre><span class="line">tag = Tags.query.filter_by(name=<span class="string">'xxx'</span>).first()  <span class="comment">#另种写法</span></span></pre></td></tr></table></figure></li>
<li>根据创建时间倒序，获取所有标签(desc)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.order_by(Tags.create_time.desc())</span></pre></td></tr></table></figure></li>
<li>获取所有标签的数量(count)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count = Tags.query.count()</span></pre></td></tr></table></figure></li>
<li>获取10个标签  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.limit(<span class="number">10</span>)</span></pre></td></tr></table></figure></li>
<li>切片查询，获取标签的1-10(多用于分页)(slice)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.slice(<span class="number">1</span>,<span class="number">11</span>)</span></pre></td></tr></table></figure></li>
<li>查询标签name中带有xxx的某一标签模糊查询(like)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tag = Tags.query.filter(Tags.name.like(<span class="string">"%xxx%"</span>)).first()</span></pre></td></tr></table></figure></li>
<li>查询标签name中包含xxx的某个标签(contains)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tag = Tags.query.filter(Tags.name.contains(<span class="string">'xxx'</span>)).first()</span></pre></td></tr></table></figure></li>
<li>查询标签name的小写等于xxx的标签(func.lower)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func </span></pre></td></tr><tr><td class="code"><pre><span class="line">tag = Tags.query.filter(func.lower(Tags.name)==<span class="string">'xxx'</span>).first()</span></pre></td></tr></table></figure></li>
<li>查询标签表name一列(with_entitles)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">names = Tags.query.with_entitles(Tags.name).all()</span></pre></td></tr></table></figure></li>
<li>查询标签表name一列去重(distinct)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">names = Tags.query.with_entitles(Tags.name).distinct().all()</span></pre></td></tr></table></figure></li>
<li>查询标签name以x开头的所有标签(startswith)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(Tags.name.startswith(<span class="string">'x'</span>)).all()</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>通过关系查询</strong></p>
<ul>
<li>查询标签name=xxx下所有的漏洞库  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">vuls = Tags.query.filter_by(name=<span class="string">'xxx'</span>).vuls</span></pre></td></tr></table></figure></li>
<li>查询漏洞库name=xxx的所有标签  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Vuls.query.filter_by(name=<span class="string">'xxx'</span>).tags</span></pre></td></tr></table></figure></li>
<li>将标签name=xxx，添加到name=yyy的漏洞库上  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tag = Tage.query.filter_by(name=<span class="string">'xxx'</span>).first()</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Vuls.query.filter_by(name=<span class="string">'xxx'</span>).tags</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags.append(tag)</span></pre></td></tr></table></figure>
<blockquote>
<p>其实多对多的操作，就是<code>list</code>操作，多的方面是一个列表，对应的增删改，及为列表的增删改</p>
</blockquote>
</li>
</ul>
<h3 id="0x02-进阶操作"><a href="#0x02-进阶操作" class="headerlink" title="0x02 进阶操作"></a>0x02 进阶操作</h3><p><strong>时间查询</strong></p>
<ul>
<li>查询指定创建日期的所有标签(extract)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> extract</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span></pre></td></tr><tr><td class="code"><pre><span class="line">today = date.today()</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(extract(<span class="string">'year'</span>, Tags.create_time)==today.year,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        extract(<span class="string">'month'</span>, Tags.create_time)==today.month,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        extract(<span class="string">'day'</span>, Tags.create_time)==today.day).all()</span></pre></td></tr></table></figure></li>
<li>查询某个时间段之间的所有创建的标签(between)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> between</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(Tags.create_time.between(<span class="string">'1990-01-01'</span>,<span class="string">'1990-01-02'</span>))</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>多条件查询</strong></p>
<ul>
<li>查询name=xxx并且create_time=xxx的某个标签(and_)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> and_</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(and_(Tags.name==<span class="string">'xxx'</span>, Tags.create_time==<span class="string">'xxx'</span>)).first()</span></pre></td></tr></table></figure></li>
<li>查询name=xxx或者create_time=xxx的某个标签(or_)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> or_</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(or_(Tags.name==<span class="string">'xxx'</span>, Tags.create_time==<span class="string">'xxx'</span>)).first()</span></pre></td></tr></table></figure></li>
<li>查询标签name在[‘xxx’,’yyy’,’zzz’]列表中的所有(in_)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(Tags.name.in_([<span class="string">'xxx'</span>,<span class="string">'yyy'</span>,<span class="string">'zzz'</span>])).all()</span></pre></td></tr></table></figure></li>
<li>查询标签name不是以x开头的所有标签(not_)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> not_</span></pre></td></tr><tr><td class="code"><pre><span class="line">tags = Tags.query.filter(not_(Tags.name.startswith(<span class="string">'x'</span>))).all()</span></pre></td></tr></table></figure></li>
</ul>
<p><strong>工作中遇到的</strong></p>
<ul>
<li>在开发观星资产中，不定查询条件(text)  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span></pre></td></tr><tr><td class="code"><pre><span class="line">dict = request.args.to_dict()</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> dict.items():</span></pre></td></tr><tr><td class="code"><pre><span class="line">    asert_obj = asert_obj.filter(text(<span class="string">"%s = '%s'"</span> % (k, v)))</span></pre></td></tr></table></figure>
<h3 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h3>进记录下使用过的查询，以后会继续更新在工作中用到的查询。</li>
</ul>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Flask-Sqlalchemy</tag>
      </tags>
  </entry>
  <entry>
    <title>Python生成验证码</title>
    <url>/2019/12/16/Python%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81/</url>
    <content><![CDATA[<p>在开发中许多地方要用到验证码，验证码的一般限制用户进行表单提交的时候进行爆破，这篇文章记录Python如何生成验证码。</p>
<a id="more"></a>
<p>验证码的生成主要注意到这几点</p>
<ul>
<li>验证码的宽高</li>
<li>验证码字体</li>
<li>验证码内容</li>
<li>干扰线</li>
<li>噪点</li>
</ul>
<p>满足这几点就可以生成一张验证码，下面代码是我之前学习Flask，copy别人的代码，之前都在用这串代码实现验证码功能,这里记录下，方便以后copy。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Image：一个画布</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># ImageDraw：一个画笔</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># ImageFont:画笔的字体</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont, ImageFilter</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># pip install pillow</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># Captcha验证码</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Captcha</span><span class="params">(object)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 生成几位数的验证码</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    number = <span class="number">4</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 验证码图片的宽度和高度</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    size = (<span class="number">100</span>, <span class="number">30</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 验证码字体大小</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    fontsize = <span class="number">25</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 加入干扰线的条数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    line_number = <span class="number">2</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 构建一个验证码源文本</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    SOURCE = list()</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        SOURCE.append(str(index))</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 用来绘制干扰线</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gene_line</span><span class="params">(cls, draw, width, height)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        begin = (random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        end = (random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        draw.line([begin, end], fill=cls.__gene_random_color(), width=<span class="number">2</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 用来绘制干扰点</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gene_points</span><span class="params">(cls, draw, point_chance, width, height)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        chance = min(<span class="number">100</span>, max(<span class="number">0</span>, int(point_chance)))  <span class="comment"># 大小限制在[0, 100]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> w <span class="keyword">in</span> range(width):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> range(height):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                tmp = random.randint(<span class="number">0</span>, <span class="number">100</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">if</span> tmp &gt; <span class="number">100</span> - chance:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    draw.point((w, h), fill=cls.__gene_random_color())</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 生成随机的颜色</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gene_random_color</span><span class="params">(cls, start=<span class="number">0</span>, end=<span class="number">255</span>)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        random.seed()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> (random.randint(start, end), random.randint(start, end), random.randint(start, end))</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 随机选择一个字体</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__gene_random_font</span><span class="params">(cls)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        fonts = [</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="string">'verdana.ttf'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        ]</span></pre></td></tr><tr><td class="code"><pre><span class="line">        font = random.choice(fonts)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'utils/captcha/'</span> + font</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 用来随机生成一个字符串(包括英文和数字)</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gene_text</span><span class="params">(cls, number)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># number是生成验证码的位数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join(random.sample(cls.SOURCE, number))</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># 生成验证码</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">    @classmethod</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gene_graph_captcha</span><span class="params">(cls)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 验证码图片的宽和高</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        width, height = cls.size</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 创建图片</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># R：Red（红色）0-255</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># G：G（绿色）0-255</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># B：B（蓝色）0-255</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># A：Alpha（透明度）</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        image = Image.new(<span class="string">'RGBA'</span>, (width, height), cls.__gene_random_color(<span class="number">0</span>, <span class="number">100</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 验证码的字体</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        font = ImageFont.truetype(cls.__gene_random_font(), cls.fontsize)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 创建画笔</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        draw = ImageDraw.Draw(image)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 生成字符串</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        text = cls.gene_text(cls.number)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 获取字体的尺寸</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        font_width, font_height = font.getsize(text)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 填充字符串</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        draw.text(((width - font_width) / <span class="number">2</span>, (height - font_height) / <span class="number">2</span>), text, font=font,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                  fill=cls.__gene_random_color(<span class="number">150</span>, <span class="number">255</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 绘制干扰线</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, cls.line_number):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            cls.__gene_line(draw, width, height)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># 绘制噪点</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        cls.__gene_points(draw, <span class="number">10</span>, width, height)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># image.filter(ImageFilter.EDGE_ENHANCE_MORE)</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> (text, image)</span></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>验证码</tag>
      </tags>
  </entry>
  <entry>
    <title>requests内容编码问题</title>
    <url>/2019/12/14/requests%E5%86%85%E5%AE%B9%E7%BC%96%E7%A0%81%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>在requests获取html内容的时候，由于页面编码格式的问题，有时候会出出现乱码的问题，这里记录下统一的解决方法。</p>
<a id="more"></a>

<blockquote>
<p>先写一段获取百度首页的代码</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span></pre></td></tr><tr><td class="code"><pre><span class="line">req = requests.get(<span class="string">'https://www.baidu.com'</span>).text()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(req)</span></pre></td></tr></table></figure>

<p>这段代码执行后，后获取百度首页的html代码，但是有些网站获取html代码就可能不那么轻松了，可能就会出现编码问题，也不演示这么多，大多说html的编码是<code>utf-8</code>,但是不排除其他编码方式的存在，为了解决这个问题，让指定正确的编码方式，<code>requests</code>中封装了获取页面编码方式的方法。以后获取页面源码的时候可以这样写，增加代码的健壮性。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span></pre></td></tr><tr><td class="code"><pre><span class="line">req = requests.get(<span class="string">'https://www.baidu.com'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> req.status_code == <span class="number">200</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">    req.encoding = req.apparent_encoding</span></pre></td></tr><tr><td class="code"><pre><span class="line">    print(req.text())</span></pre></td></tr></table></figure>
<p>通过添加设置<code>apparent_encoding</code>，调用chardet.detect()来识别文本编码，可以实现自动编码。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Requests</tag>
      </tags>
  </entry>
  <entry>
    <title>Boss直聘爬虫新思路</title>
    <url>/2019/12/14/Boss%E7%9B%B4%E8%81%98%E7%88%AC%E8%99%AB%E6%96%B0%E6%80%9D%E8%B7%AF/</url>
    <content><![CDATA[<p>之前写了一个爬虫项目，关于获取各大求职平台的数据，具体哪些平台就不列举了，感兴趣的话可以访问<a href="https://github.com/Joynice/FindJob" target="_blank" rel="noopener">Findjob</a>，时隔几个月后，突然有人<code>issues</code>说boss直聘不能爬了，本片文章记录如何解决反反爬虫。</p>
<a id="more"></a>

<h3 id="0x01-问题排查"><a href="#0x01-问题排查" class="headerlink" title="0x01 问题排查"></a>0x01 问题排查</h3><p>收到issues后，我将以前的项目拉下，发现Boss直聘真的运行不了了，然后查看当初拼接的查询链接的html，返回是一个跳转页面，不没有返回结果页面，通过判断某些参数，返回跳转页来隔离爬虫，最后发现<code>cookie</code>多了个<code>__zp_stoken__</code>字段这个可能就是限制是否跳转的重要参数，通过copy这个参数加在情头求头的cookie中可以正常访问，然后我就百度boss直聘的<code>__zp_stoken__</code>，听那些大佬说，这个参数是三千行js生成的，而且每天加密方式都会变化，我这还玩个毛线啊，果断放弃这条思路，这是<a href="https://blog.csdn.net/Lock_Jun/article/details/101768531" target="_blank" rel="noopener">文章链接</a>，还有这个参数的存活也是有限制的，有人说可以使用5次，也有人说可以使用几分钟，但是我一次就gg了。<br><img src="https://raw.githubusercontent.com/Joynice/image/master/img/%E6%90%9C%E7%8B%97%E6%88%AA%E5%9B%BE20191214165430.png" alt="cookie"></p>
<h3 id="0x02-解决方法"><a href="#0x02-解决方法" class="headerlink" title="0x02 解决方法"></a>0x02 解决方法</h3><ol>
<li><p>解密js获取token<br>对于我来说，比登天还难，js大佬可以调试试试</p>
</li>
<li><p>模拟浏览器<br>这种方法应该可以，但是我没尝试，因为浏览器会自动运行那段加密js，从而生成token进行验证，但是模拟浏览器太慢了，还是放弃了。</p>
</li>
<li><p>寻找其他接口<br>终于在不经意间发现了boss直聘的手机端接口，一开始发现请求的cookie中还是有token字段，准备放弃，但是还是用postman测试了下可以获得数据，nice。而且也解决了web端只能获取前十页数据限制，目前测试没有任何验证。</p>
</li>
</ol>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>www.zhipin.com<span class="regexp">/mobile/</span>jobs.json?city=<span class="number">101280600</span>&amp;query=java&amp;page=<span class="number">27</span></span></pre></td></tr></table></figure>
<p>不久之后我会将这个方法更新到项目中</p>
<h3 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h3><p>有时候成功可能就在不经意之间….</p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>Gunicorn+Nginx部署Flask项目</title>
    <url>/2019/12/14/Gunicorn-Nginx%E9%83%A8%E7%BD%B2Flask%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<p>最近上线了<a href="http://wechat.doonsec.com" target="_blank" rel="noopener">洞见微信聚合平台</a>需要部署，以前部署项目使用的<code>uwsgi</code>+<code>nginx</code>，听说<code>gunicorn</code>使用起来挺方便的，记录下部署过程。<a id="more"></a></p>
<p>生产环境不比开发环境，要适应性能强大的<code>应用服务器</code>和<code>web服务器</code>,在开发环境中，使用Flask自带的<code>wsgi</code>不能满足生产环境的需求，需要满足高性能的要求。这里不得不说，<code>1核2g</code>的阿里云服务器配置三个web项目，每天将近500的访问量不带卡的。不吹牛批了，开始正式记录。</p>
<h3 id="0X01-Flask配置"><a href="#0X01-Flask配置" class="headerlink" title="0X01 Flask配置"></a>0X01 Flask配置</h3><p>其实Flask配置没有什么好说的，需要将<code>debug</code>改为<code>True</code></p>
<h3 id="0x02-Gunicorn配置"><a href="#0x02-Gunicorn配置" class="headerlink" title="0x02 Gunicorn配置"></a>0x02 Gunicorn配置</h3><p>首先安装Gunicorn</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> gunicorn</span></pre></td></tr></table></figure>

<p>Gunicorn配置也非常方便，这里记录下常用的一条配置命令</p>
<p>在app.py同级目录下运行</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">gunicorn -b <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> -p <span class="number">5000</span> -w <span class="number">10</span> -k gevent -D app:app</span></pre></td></tr></table></figure>
<p> <strong>-b：</strong> 绑定IP<br> <strong>-p:</strong> 绑定端口<br> <strong>-w：</strong> worke数量<br> <strong>-k：</strong> 运行模式<br> <strong>-D：</strong> 开启守护进程<br> <strong>app:app：</strong> 启动文件下的app实例</p>
<h3 id="0x03-ngixn配置"><a href="#0x03-ngixn配置" class="headerlink" title="0x03 ngixn配置"></a>0x03 ngixn配置</h3><p>nginx配置需要将gunicorn绑定的端口进行消息转发就可以了</p>
<figure class="highlight tp"><table><tr><td class="code"><pre><span class="line">server &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        listen xx;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        server_name xxx;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        location / &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_pass http:<span class="comment">//127.0.0.1:5000;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_set_header Host <span class="variable">$host</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_set_header <span class="keyword">X</span>-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_set_header <span class="keyword">X</span>-Real-IP <span class="variable">$remote_addr</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_set_header REMOTE-HOST <span class="variable">$remote_addr</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                proxy_set_header referer <span class="variable">$http_referer</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">`</span></pre></td></tr></table></figure>
<p>同时记录下nginx的几条配置命令</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">nginx -t <span class="string">//</span>检查配置文件是否合法</span></pre></td></tr><tr><td class="code"><pre><span class="line">nginx -s <span class="keyword">reload</span> <span class="string">//</span>重启nginx</span></pre></td></tr></table></figure>

<p>```</p>
]]></content>
      <categories>
        <category>部署</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>部署</tag>
      </tags>
  </entry>
  <entry>
    <title>Jinja2自定义过滤器</title>
    <url>/2019/12/12/Jinja2%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    <content><![CDATA[<p><code>Jinja2</code>本身自带许多过滤器，但是有些功能实现需要自己设计特定的过滤器，我熟悉的有两种实现的方法，这里记录经常使用的一种方法。</p>
<a id="more"></a>

<blockquote>
<p>以难度判断记录下，通过判断1-5，返回不同的难度等级</p>
</blockquote>
<p>过滤函数:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Num2Nandu</span><span class="params">(num)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(num, int):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'暂无'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'入门'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">elif</span> num == <span class="number">2</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'初级'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">elif</span>  <span class="number">2</span>&lt;num&lt;=<span class="number">4</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'中级'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">elif</span> num == <span class="number">5</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'高级'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">'暂无'</span></span></pre></td></tr></table></figure>

<p>将过滤函数添加到模板过滤器中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bp.add_app_template_filter(Num2Nandu, <span class="string">'Num2Nandu'</span>)  <span class="comment">#过滤数字-难度，第二个参数为过滤器的名字</span></span></pre></td></tr></table></figure>

<p>前端使用自定义的过滤器</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"Ori-pic"</span>&gt;</span>&#123;&#123; vul.stars|Num2Nandu &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>  <span class="comment">&lt;!--传入int进行过滤---&gt;</span></span></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Jinja2</tag>
      </tags>
  </entry>
  <entry>
    <title>Flask-Sqlalchemy简单使用</title>
    <url>/2019/12/11/Flask-Sqlalchemy%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>在开发过程中需要借助数据库来存储相关信息，在关系型数据库中可能就需要关系来处理事物之间的逻辑，而<code>Flask</code>中的<code>Flask-Sqlalchemy</code>使用<code>orm</code>来实现对象关系映射，这个对于不熟悉原生sql语句的开发者来说，真是福音。本片文章主要记录一些简单的操作。</p>
<a id="more"></a>

<p>开发漏洞靶场的时候，使用重新记录下相关操作，从数据库配置、数据库模型设计以及迁移、数据增删改查等方面记录整个流程。</p>
<h3 id="0X01-数据库配置"><a href="#0X01-数据库配置" class="headerlink" title="0X01 数据库配置"></a>0X01 数据库配置</h3><blockquote>
<p>在开发这套系统的时候，使用的<code>mysql</code>数据库，而<code>Flask-Sqlalchemy</code>支持多种关系型数据库。</p>
</blockquote>
<p>这里记录下使用<code>Flask-Sqlalchemy</code>配合<code>mysql</code>相关配置</p>
<p>简单Flask项目，我习惯的文件结构如下：<br><img src="https://raw.githubusercontent.com/Joynice/image/master/img/%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.JPG" alt="文件结构"></p>
<p>下面所写的文件基本按照此文件结构，这是一个简单的项目：<a href="https://github.com/Joynice/shicimingju" target="_blank" rel="noopener">诗词名句网获取展示</a> 有兴趣可以踩踩</p>
<p><strong>config.py</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mysql设置</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span></pre></td></tr><tr><td class="code"><pre><span class="line">MYSQL_HOST = <span class="string">'xxx'</span> <span class="comment">#host</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MYSQL_PORT = <span class="number">3306</span>  <span class="comment">#port</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MYSQL_DATABASE = <span class="string">'xxx'</span>  <span class="comment">#db_name</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MYSQL_USERNAME = <span class="string">'xxx'</span>  <span class="comment">#db_username</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MYSQL_PASSWORD = <span class="string">'xxx'</span>  <span class="comment">#db_password</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = <span class="string">'mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;?charset=utf8'</span>.format(MYSQL_USERNAME, MYSQL_PASSWORD,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                                                                MYSQL_HOST, MYSQL_PORT,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                                                                MYSQL_DATABASE)</span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span>  <span class="comment">#是否追踪对象的修改</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_COMMIT_ON_TEARDOWN = <span class="literal">False</span> <span class="comment">#每次请求结束后都会自动提交数据库中的变动</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_POOL_SIZE = <span class="number">100</span>   <span class="comment">#数据库连接池的大小。默认是引擎默认值（通常 是 5 ）</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_MAX_OVERFLOW = <span class="number">20</span>  <span class="comment">#控制连接池达到最大大小后还可以创建的连接数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_ECHO = <span class="literal">False</span>  <span class="comment">#是否输出stderr的语句</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">SQLALCHEMY_POOL_RECYCLE = <span class="number">90</span>  <span class="comment">#多少秒后自动回收连接</span></span></pre></td></tr></table></figure>
<p>上面基本上涵盖了所有关于<code>Flask-Sqlalchemy</code>的配置，下面就需要将<code>Flask-Sqlalchemy</code>初始化app。这部分，我的习惯创建<code>exts.py</code>进行<code>SQLAlchemy</code>类的实例,这样会解决循环导入的问题</p>
<p><strong>exts.py</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span></pre></td></tr><tr><td class="code"><pre><span class="line">db = SQLAlchemy()</span></pre></td></tr></table></figure>
<p>然后在<code>app.py</code>中在导入<code>db</code>进行初始化app</p>
<p><strong>app.py</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.init_app(app)</span></pre></td></tr></table></figure>
<p>这样就基本完了相关配置,这里的代码只是其中核心部分</p>
<h3 id="0x02-数据库模型设计以及迁移"><a href="#0x02-数据库模型设计以及迁移" class="headerlink" title="0x02 数据库模型设计以及迁移"></a>0x02 数据库模型设计以及迁移</h3><p>因为作为简单的例子，不必要的字段就不进行写了，在设计多对多的关系时，我的习惯就是创建中间表进行关联,这里展示模型设计。<br><strong>models.py</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tags</span><span class="params">(db.Model)</span>:</span>  <span class="comment">#标签表</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    漏洞的标签：id、名称、创建时间</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    __tablename__ = <span class="string">'t_tags'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    name = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">True</span>, comment=<span class="string">'漏洞标签名称'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    create_time = db.Column(db.DateTime, default=datetime.datetime.now, comment=<span class="string">'加入时间'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    vuls = db.relationship(<span class="string">'Vuls'</span>, secondary=vul_tag, backref=<span class="string">'tags'</span>)  <span class="comment"># 设置关系，通过中间表`t_vul_tag`实现</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vuls</span><span class="params">(db.Model)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    靶场漏洞库</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    __tablename__ = <span class="string">'t_vuls'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>) <span class="comment">#uuid</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    name = db.Column(db.String(<span class="number">255</span>), nullable=<span class="literal">True</span>, comment=<span class="string">'漏洞名称'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    create_time = db.Column(db.DateTime, default=datetime.datetime.now, comment=<span class="string">'加入时间'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    vul_tag = db.Table(  <span class="comment">#中间表，表名`t_vul_tag`</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'t_vul_tag'</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.Column(<span class="string">'t_vul_id'</span>, db.Integer, db.ForeignKey(<span class="string">'t_vuls.id'</span>), primary_key=<span class="literal">True</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.Column(<span class="string">'t_tag_id'</span>, db.Integer, db.ForeignKey(<span class="string">'t_tags.id'</span>), primary_key=<span class="literal">True</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">)</span></pre></td></tr></table></figure>

<p>这样就可以实现题目和标签之间多对多的关系。</p>
<p>模型设计好了，就需要映射到数据库中实实在在的表了,通常习惯创建<code>manages.py</code>文件来写些方便的操作和进行数据库迁移，这里仅进行记录如何进行数据库迁移。</p>
<p><strong>manages.py</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">__author__ = <span class="string">'Joynice'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate, MigrateCommand</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> apps.admin.models <span class="keyword">import</span> Upload_Log</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">app = create_app()</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">manager = Manager(app)</span></pre></td></tr><tr><td class="code"><pre><span class="line">Migrate(app, db)</span></pre></td></tr><tr><td class="code"><pre><span class="line">manager.add_command(<span class="string">'db'</span>, MigrateCommand)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">    manager.run()</span></pre></td></tr></table></figure>
<p>基本上就这样写就可以，<br>然后运行以下命令进行数据库的迁移</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">python manages.py db init  #初始化</span></pre></td></tr><tr><td class="code"><pre><span class="line">python manages.py db migrate  #迁移</span></pre></td></tr><tr><td class="code"><pre><span class="line">python manages.py db<span class="built_in"> upgrade </span> #生成</span></pre></td></tr></table></figure>
<p>运行完上述命令后，就会在数据库中生成三个表,就可以继续下面的操作了。</p>
<h3 id="0x03-数据库增删改查"><a href="#0x03-数据库增删改查" class="headerlink" title="0x03 数据库增删改查"></a>0x03 数据库增删改查</h3><p>使用<code>Flask-Sqlalchemy</code>进行增删改查非常的方便，不需要设计原生的sql语句，只需要对模型操作就可以了，以题目-标签为例子，进行增删改查操作。</p>
<ul>
<li>增<ul>
<li>增加标签  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Tags</span></pre></td></tr><tr><td class="code"><pre><span class="line">tag = Tags(name=<span class="string">'xxx'</span>, create_time=<span class="string">'xxx'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.add(tag)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure></li>
<li>添加题目  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Vuls</span></pre></td></tr><tr><td class="code"><pre><span class="line">vul = Vuls(name=<span class="string">'xxx'</span>, create_time=<span class="string">'xxx'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.add(vul)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure></li>
</ul>
</li>
<li>删<br>  删除标签(id为1)：删除标签的时候多先进行查询再进行删除  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Tags</span></pre></td></tr><tr><td class="code"><pre><span class="line">tag = Tags.query.get(<span class="number">1</span>) <span class="comment">#这种查询方法只是试用对`主键`查询</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.delete(tag)</span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure></li>
<li>改<br>  更改标签name=’ceshi’:修改操作也多在查询之后进行，这里也对id=1的数据修改  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> exts <span class="keyword">import</span> db</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> models <span class="keyword">import</span> Tags</span></pre></td></tr><tr><td class="code"><pre><span class="line">tag = Tags.query.get(<span class="number">1</span>) <span class="comment">#这种查询方法只是试用对`主键`查询</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">tag.name = <span class="string">'ceshi'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit()</span></pre></td></tr></table></figure></li>
<li>查<br>  查的话上面操作已经有体现了</li>
</ul>
<p>这片文章仅记录下简单的<code>Flask-Sqlalchemy</code>的流程，以后会对更新一些文章关于<code>Flask-Sqlalchemy</code>的进阶操作，比如关系操作、复杂查询等等。</p>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Flask-Sqlalchemy</tag>
      </tags>
  </entry>
  <entry>
    <title>Layui评分模块使用</title>
    <url>/2019/12/11/Layui%E8%AF%84%E5%88%86%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>在漏洞靶场的开发中，使用Layui的<code>rate</code>评分模块来对每个漏洞进行难度评分，默认值1-5，分别代替这不同的难度，简单的使用<code>rate</code>可以看看官方文档就可以实现，但是这次在table和form中实现取值和赋值操作，记录下以供以后参考。<a id="more"></a></p>
<h3 id="0x01-table中进行初始化赋值"><a href="#0x01-table中进行初始化赋值" class="headerlink" title="0x01 table中进行初始化赋值"></a>0x01 table中进行初始化赋值</h3><p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/%E9%9A%BE%E5%BA%A6.JPG" alt="难度赋值"></p>
<p>在对table中的星星进行赋值的时候，并没有找到好的方法，因为文档上给的方法，都是值指定元素进行渲染，而我只有数据，并没有指定的元素，而且我要对所有题目进行赋值，最终想到了一个方法解决。在table赋值的时候，然后有每个题目特征的div，在table加载成功后调用<code>done</code>函数对div进行渲染。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">, &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    field: <span class="string">'stars'</span>, <span class="attr">title</span>: <span class="string">'难度'</span>, <span class="attr">width</span>: <span class="number">170</span>, <span class="attr">templet</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;div id="avgScore'</span> + res.id + <span class="string">'"&gt;&lt;/div&gt;'</span>   <span class="comment">//返回id以'avgScore'开头，以题目id结尾的div</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>上述代码，就是返回带有题目特征的div</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">done: <span class="function"><span class="keyword">function</span> (<span class="params">res, curr, count</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">var</span> data = res.data;<span class="comment">//返回的json中data数据</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> item <span class="keyword">in</span> data) &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        rate.render(&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            elem: <span class="string">'#avgScore'</span> + data[item].id + <span class="string">''</span>         <span class="comment">//绑定元素</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            , <span class="attr">length</span>: <span class="number">5</span>            <span class="comment">//星星个数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            , <span class="attr">value</span>: data[item].stars             <span class="comment">//初始化值</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            , <span class="attr">readonly</span>: <span class="literal">true</span>      <span class="comment">//只读</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>上述代码，就是对table中的所有特征div进行渲染,将<code>readonly:true</code>只读，不能设置。</p>
<p>但是现实的样式并不美，星星并不上下居中,修改样式如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.layui-rate</span> &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span></pre></td></tr><tr><td class="code"><pre><span class="line">4&#125;</span></pre></td></tr></table></figure>

<h3 id="0x02-form中进行初始化赋值"><a href="#0x02-form中进行初始化赋值" class="headerlink" title="0x02 form中进行初始化赋值"></a>0x02 form中进行初始化赋值</h3><p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/%E8%B5%8B%E5%80%BC.JPG" alt="from中进行赋值"></p>
<p>在进行题目编辑的时候使用form表单展示，这里需要将值赋值给form中的元素，这里的赋值就是简单的官方提供的<code>rate</code>赋值,在form弹出成功的<code>success</code>回调函数中进行初始化赋值:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-form-item"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"layui-form-label"</span>&gt;</span>题目难度<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-input-block"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"rate"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    rate.render(&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        elem: <span class="string">'#rate'</span>    <span class="comment">//绑定元素</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            , <span class="attr">length</span>: <span class="number">5</span>     <span class="comment">//星星个数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            , <span class="attr">value</span>: data.stars     <span class="comment">//初始化值</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">4&#125;</span></pre></td></tr></table></figure>

<h3 id="0x03-form中设置并取值"><a href="#0x03-form中设置并取值" class="headerlink" title="0x03 form中设置并取值"></a>0x03 form中设置并取值</h3><p>这里的话就需要，重新设置难度值，通过提交按钮，获取用户设置的值，传递给后端。</p>
<p><code>rate</code>模块中只有点击产生的回调，并没有点击按钮后的回调，这部分需要自己取值。</p>
<p>设置值非常简单，只需要将<code>readonly:true</code>设置为false，就可以进行赋值，取值的过程实现有点坎坷，最后通过这个方法解决：星星亮起来后，会有个添加<code>layui-icon-rate-solid</code>的class，所以只需要获取这class的个数，就可以获得用户设置的值了。还是出现一个问题，就是应为页面的table中有好多的亮起的星星，如果直接获取的话，就是整个页面的值，并不是指定题目的难度系数，所以需要获取弹窗中<code>layui-icon-rate-solid</code>的个数，最后获取代码如下:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> star = $(<span class="string">".layui-layer .layui-icon-rate-solid"</span>).length; <span class="comment">//获取当前弹窗的题目的star数,方法：获取layui-icon-rate-solid类的个数。</span></span></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Layui</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Layui</tag>
      </tags>
  </entry>
  <entry>
    <title>Flask中使用celery实现异步操作</title>
    <url>/2019/12/10/Flask%E4%B8%AD%E4%BD%BF%E7%94%A8celery%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>Flask自身并没有异步功能，但是后端遇到些超时操作，前端只能等待，那么Celery就可以实现异步操作，满足开发中的需求。</p>
<a id="more"></a>

<h3 id="0x01-Celery"><a href="#0x01-Celery" class="headerlink" title="0x01 Celery"></a>0x01 Celery</h3><p>Celery是一个简单、灵活而且可靠的，能够处理大量消息的分布式系统，并且提供维护这样一个系统的必要工具，Celery支持使用任务队列的方式在分布的机器、进程、线程上执行任务调度。</p>
<p>Celery的架构有消息中间件（message broker），执行任务单元（worker）和任务执行结果存储（task result store）三个部分组成。</p>
<ol>
<li><p>消息中间件<br>Celery本身不提供消息服务，但是可以方便和第三方提供的消息中间件集成。包括RabbitMQ、Redis等等</p>
</li>
<li><p>执行任务单元<br>Worker是Celery提供的认为执行单元，worker并发运行在分布式的系统节点中。</p>
</li>
<li><p>任务结果存储<br>Task result store用来存储Worker执行的任务结果，Celery支持不同方式存储任务结果，包括AMQP、Redis等等。<br>Celery统筹三个单元，相互合作完成任务，充分运用了生产者消费者模型，而Wokers可以分布式部署，增加代码执行效率。用户下发任务到消息队列中，而Worker不断监视消息队列的状况，一单任务下发，Worker获得任务，开始工作，完后工作后在把返回的结果存入任务结果存储单元中。</p>
</li>
</ol>
<p>Celery可以配置参数协调任务队列进行任务调度，支持及时任务以及定时任务，自身可以解决任务逻辑，减少程序开销，加快项目开发。</p>
<h3 id="0x02-Flask中使用Celery"><a href="#0x02-Flask中使用Celery" class="headerlink" title="0x02 Flask中使用Celery"></a>0x02 Flask中使用Celery</h3><p>在Flask中就可以把耗时任务交给Celery，这样可以优化前端用户体验，就给用户发送邮件功能而说，这就是一个耗时任务，如果不使用Celery的话，同步实现发邮件，前台用户在点击获取邮件后，会在3-4秒后页面才会弹窗，发送邮件成功，这个是个同步运行过程，用户体验不好，并且在这3-4秒钟内，并不知道是否执行发送邮件的命令。使用Celery就不同了，用户点击发送邮件按钮后，会把任务交给Celery来完成，并不需要等待发送邮件的过程。</p>
<h3 id="0x03-实例"><a href="#0x03-实例" class="headerlink" title="0x03 实例"></a>0x03 实例</h3><p>说了这么多，很多人还说<code>not give me bb, show me in code</code>，好的，我就发送邮件功能给出个栗子。</p>
<ul>
<li>Celery_Example<ul>
<li>config.py</li>
<li>tasks.py</li>
<li>view.py</li>
</ul>
</li>
</ul>
<p>简单的文件结构</p>
<p><strong>config.py：主要写些邮件和Celery的配置文件</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发送者邮箱的服务器地址</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_SERVER = <span class="string">"smtp.qq.com"</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_PORT = <span class="string">'587'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_USE_TLS = <span class="literal">True</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># MAIL_USE_SSL</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_USERNAME = <span class="string">'xxxx@qq.com'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_PASSWORD = <span class="string">'xxxx'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">MAIL_DEFAULT_SENDER = <span class="string">'xxxx@qq.com'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment">#celery相关的配置, 中间件使用redis</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">CELERY_RESULT_BACKEND = <span class="string">'redis://xxxx:6379/x'</span>  <span class="comment">#任务结果存储</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">CELERY_BROKER_URL = <span class="string">'redis://xxxx:6379/x'</span>  <span class="comment">#消息存储</span></span></pre></td></tr></table></figure>

<p><strong>tasks.py: 创建Celery实例绑定app并创建发送邮件任务</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">__author__ = <span class="string">'Joynice'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message, Mail</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> config</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">app = Flask(__name__)</span></pre></td></tr><tr><td class="code"><pre><span class="line">app.config.from_object(config)</span></pre></td></tr><tr><td class="code"><pre><span class="line">mail = Mail()</span></pre></td></tr><tr><td class="code"><pre><span class="line">mail.init_app(app)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_celery</span><span class="params">(app)</span>:</span>   <span class="comment"># 创建Celery</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    celery = Celery(</span></pre></td></tr><tr><td class="code"><pre><span class="line">        app.import_name,</span></pre></td></tr><tr><td class="code"><pre><span class="line">        backend=app.config[<span class="string">'CELERY_RESULT_BACKEND'</span>],</span></pre></td></tr><tr><td class="code"><pre><span class="line">        broker=app.config[<span class="string">'CELERY_BROKER_URL'</span>]</span></pre></td></tr><tr><td class="code"><pre><span class="line">    )</span></pre></td></tr><tr><td class="code"><pre><span class="line">    celery.conf.update(app.config)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ContextTask</span><span class="params">(celery.Task)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">with</span> app.app_context():</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> self.run(*args, **kwargs)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    celery.Task = ContextTask</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> celery</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">celery = make_celery(app)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@celery.task    #创建发送邮件任务</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(subject, recipients, body)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    message = Message(subject=subject, recipients=recipients, body=body)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    mail.send(message)</span></pre></td></tr></table></figure>

<p><strong>view.py: 在视图函数中使用发送邮件功能</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tasks <span class="keyword">import</span> send_mail</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@bp.route('/email_captcha/')</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">email_captcha</span><span class="params">()</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    email = request.args.get(<span class="string">'email'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    print(email)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> email:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> restful.params_error(<span class="string">'请传递邮箱参数！'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    source = list(string.ascii_letters)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    source.extend(map(<span class="keyword">lambda</span> x: str(x), range(<span class="number">0</span>, <span class="number">10</span>)))</span></pre></td></tr><tr><td class="code"><pre><span class="line">    captcha = <span class="string">""</span>.join(random.sample(source, <span class="number">6</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">    send_mail.delay(<span class="string">'BBS论坛邮箱验证码'</span>, [email], <span class="string">'您的验证码是：&#123;&#125;'</span>.format(captcha))  <span class="comment">#Celery处理发送邮件任务</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    zlcache.set(email, captcha)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> restful.success()</span></pre></td></tr></table></figure>

<hr>
<p>这三部分是功能实现的核心，同时Celery运行命名并不是跟着<code>app.run()</code>运行的，要单独运行:</p>
<figure class="highlight isbl"><table><tr><td class="code"><pre><span class="line"><span class="variable">celery</span> 启动命令:<span class="variable">celery</span> -<span class="variable">A</span> <span class="variable"><span class="class">tasks</span>.celery</span> <span class="variable">worker</span> --<span class="variable">pool</span>=<span class="variable">eventlet</span>， 启动时保证与<span class="variable"><span class="class">tasks</span>.py</span>同级</span></pre></td></tr></table></figure>
<p>同时记录下遇到的一个坑：</p>
<figure class="highlight ocaml"><table><tr><td class="code"><pre><span class="line">若出现 <span class="symbol">'AttributeError</span>: <span class="symbol">'float'</span> <span class="keyword">object</span> has no attribute <span class="symbol">'items'</span>错误，这是redis包版本不兼容，退回<span class="number">2.10</span>.<span class="number">6</span>版本即可。</span></pre></td></tr><tr><td class="code"><pre><span class="line">pip install redis==<span class="number">2.10</span>.<span class="number">6</span></span></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Celery</tag>
      </tags>
  </entry>
  <entry>
    <title>Flask用户头像上传</title>
    <url>/2019/12/09/Flask%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F%E4%B8%8A%E4%BC%A0/</url>
    <content><![CDATA[<p>在完成用户模块时，需要用户上传头像，文件上传功能毕竟属于开发过程中重要的模块，也是出现漏洞较多的点，所以写起来十分小心，并记录下。<a id="more"></a></p>
<blockquote>
<p>在用户注册的时候，平台会自动生成一张图片作为用户的头像，后续用户可以自己上传自己喜欢的头像。</p>
</blockquote>
<h3 id="0x01-用户头像随机生成"><a href="#0x01-用户头像随机生成" class="headerlink" title="0x01 用户头像随机生成"></a>0x01 用户头像随机生成</h3><p>平台头像仿<code>Github</code>初始的头像，回生成随机的头像，具体代码如下，网上应该也有源代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">__author__ = <span class="string">'Joynice'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random, math</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GithubAvatarGenerator</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    Github default avatar is a 420*420 image contains 5*5 block vertex.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    Each block is a 70*70 square.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    The width of the frame around block vertex is 35px.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    This is an example avatar.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    https://raw.githubusercontent.com/josephzxy/pic/master/example_github_avatar.png</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    This class aims at generating a github-avatar-like avatars.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    Usage:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        - Initialize this class</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        - Call get_randowm_avatar()</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    avatar_width = <span class="number">420</span>  <span class="comment"># the length of line of the avatar</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    block_vertex_dimension = <span class="number">5</span>  <span class="comment"># the dimension of block vertex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    block_width = <span class="number">70</span>  <span class="comment"># the length of line of block</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    background_color = [<span class="number">230</span>, <span class="number">230</span>, <span class="number">230</span>]  <span class="comment"># the brackground color</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    frame_width = <span class="number">35</span>  <span class="comment"># the width of frame surrounding block vertex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="comment"># some color that might be approiprate for the color of block.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    color_pool_rgb = (</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">170</span>, <span class="number">205</span>, <span class="number">102</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">159</span>, <span class="number">255</span>, <span class="number">84</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">209</span>, <span class="number">206</span>, <span class="number">0</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">47</span>, <span class="number">107</span>, <span class="number">85</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">47</span>, <span class="number">255</span>, <span class="number">173</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">0</span>, <span class="number">173</span>, <span class="number">205</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">8</span>, <span class="number">101</span>, <span class="number">139</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">180</span>, <span class="number">180</span>, <span class="number">238</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">106</span>, <span class="number">106</span>, <span class="number">255</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">155</span>, <span class="number">211</span>, <span class="number">255</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">204</span>, <span class="number">50</span>, <span class="number">153</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        (<span class="number">101</span>, <span class="number">119</span>, <span class="number">139</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    )</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_avatar_vertex</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        Generate a vertex of which each value is a boolean value.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        This 5*5 vertex denotes the strcture of 5*5 block vertex in github avatar</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># get 5*5 2d array full of False</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        avatar_vertex = np.empty((self.block_vertex_dimension, self.block_vertex_dimension), dtype=np.bool)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> avatar_vertex:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(math.ceil(self.block_vertex_dimension / <span class="number">2</span>)):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                row[i] = <span class="literal">True</span> <span class="keyword">if</span> random.randint(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span> <span class="keyword">else</span> <span class="literal">False</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># copy left half to right half</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> avatar_vertex:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(math.floor(self.block_vertex_dimension / <span class="number">2</span>)):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                row[self.block_vertex_dimension - <span class="number">1</span> - i] = row[i]</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> avatar_vertex</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_avatar_data</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        Generate a 3d array contains color info in each pixel in the avatar</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">        '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># fill the whole img with the background</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        avatar_data = np.zeros((self.avatar_width, self.avatar_width, <span class="number">3</span>), dtype=np.uint8)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        avatar_data[:][:] = self.background_color</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        rand_color_index = random.randint(<span class="number">0</span>, len(self.color_pool_rgb))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        rand_color = self.color_pool_rgb[rand_color_index]</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        avatar_vertex = self._get_avatar_vertex()</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="comment"># add blocks according to avatar vertex</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(avatar_vertex)):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(avatar_vertex[i])):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                is_True = avatar_vertex[i][j]</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">if</span> is_True:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    up_left_point = (self.frame_width + i * self.block_width, self.frame_width + j * self.block_width)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> range(self.block_width):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        <span class="keyword">for</span> l <span class="keyword">in</span> range(self.block_width):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            lvl1 = k + up_left_point[<span class="number">0</span>]</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            lvl2 = l + up_left_point[<span class="number">1</span>]</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            avatar_data[lvl1][lvl2] = rand_color</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="keyword">continue</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> avatar_data</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_random_avatar</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        img = self._get_avatar_data()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        cv2.imshow(<span class="string">'My pic'</span>, img)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        cv2.waitKey()</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_avatar</span><span class="params">(self, filepath)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        img = self._get_avatar_data()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        cv2.imwrite(filepath, img)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">    gen = GithubAvatarGenerator() <span class="comment">#初始化类</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    gen.save_avatar(filepath=<span class="string">'../static/cms/img/user/111.png'</span>) <span class="comment">#保存路径</span></span></pre></td></tr></table></figure>

<h3 id="0x02-平台头像绑定用户"><a href="#0x02-平台头像绑定用户" class="headerlink" title="0x02 平台头像绑定用户"></a>0x02 平台头像绑定用户</h3><p>有头像了，下面就要在用户注册的时候，生成随机头像绑定用户，这里在数据库中有个<code>avatar_path</code>字段用来保存头像存储路径，路径要存相对路径或者使用<code>os.path.dirname(os.path.abspath(__file__))</code>获取项目路径，然后进行路径拼接。头像命名的话，我这里使用用户邮箱进行命名。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@manager.option('-u', '--username', dest='username')</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@manager.option('-p', '--password', dest='password')</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@manager.option('-e', '--email', dest='email')</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_cms_user</span><span class="params">(username, password, email)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    avatar = GithubAvatarGenerator()  <span class="comment">#chu初始化类</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    path = <span class="string">'../static/cms/img/user/'</span>+ email +<span class="string">'.png'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    avatar.save_avatar(filepath=<span class="string">'./static/cms/img/user/'</span>+ email +<span class="string">'.png'</span>) <span class="comment">#头像保存本地</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    user = User(username=username, password=password, email=email, avatar_path=path)  <span class="comment">#创建用户</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.session.add(user) <span class="comment">#添加</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    db.session.commit()  <span class="comment">#提交</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    print(<span class="string">'用户添加成功'</span>)</span></pre></td></tr></table></figure>

<h3 id="0x03-用户修改头像"><a href="#0x03-用户修改头像" class="headerlink" title="0x03 用户修改头像"></a>0x03 用户修改头像</h3><p>用户修改头像的话，有几个注意点:</p>
<ul>
<li>用户头像图片类型（png、jpg等常规图片类型检查）</li>
<li>用户上传头像大小限制</li>
<li>用户上传完图片后，重命名保存（防止图片马）</li>
</ul>
<p>前端图片上传的话使用过两个插件,<a href="http://www.bootstrap-fileinput.com/" target="_blank" rel="noopener" title="fileinput">fileinput</a>和<a href="https://www.layui.com/doc/modules/upload.html" target="_blank" rel="noopener">Layui</a>中的图片上传功能，其基本实现都差不多，<code>fileinput</code>这个插件好久没用了，这个插件基于<code>bootstrap</code>，需要导入相关依赖,所有这里用<code>Layui</code>做演示，支持国产，但不得不说“坑”有点多。<br><img src="https://raw.githubusercontent.com/Joynice/image/master/img/%E4%B8%8A%E4%BC%A0.JPG" alt="上传"><br>实现如图的功能，具体弹窗、表单就不说了，主要记录图片上传功能，这个功能主要是给每个题目上传一个背景图，同时具有修改背景图的功能。非常类似用户修改头像。</p>
<ul>
<li>html</li>
</ul>
<p>html代码中用到<code>Layui</code>的<code>form</code>，代码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"layui-form"</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">lay-filter</span>=<span class="string">"example2"</span> <span class="attr">id</span>=<span class="string">"upload_img"</span> <span class="attr">style</span>=<span class="string">"display: none"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-form-item"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"layui-form-label"</span>&gt;</span>题目ID<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-input-inline"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"number"</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">lay-verify</span>=<span class="string">"required"</span> <span class="attr">autocomplete</span>=<span class="string">"off"</span> <span class="attr">placeholder</span>=<span class="string">"请输入题目ID"</span> <span class="attr">class</span>=<span class="string">"layui-input"</span> <span class="attr">disabled</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-form-item"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"layui-form-label"</span>&gt;</span>上传图片<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-input-inline uploadHeadImage"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-upload-drag"</span> <span class="attr">id</span>=<span class="string">"headImg"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"layui-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="tag">&lt;<span class="name">p</span>&gt;</span>点击上传图片，或将图片拖拽到此处<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-input-inline"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-upload-list"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"layui-upload-img headImage"</span> <span class="attr">id</span>=<span class="string">"demo1"</span> <span class="attr">width</span>=<span class="string">"200"</span> <span class="attr">height</span>=<span class="string">"150"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"demoText"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></pre></td></tr></table></figure>
<p>html中在第二个<code>layui-form-item</code>设置图片上传，同时form样式设置<code>display:none</code>配合<code>Layui</code>的弹出层使用。</p>
<ul>
<li>js</li>
</ul>
<p>js代码中实现文件上传,<code>Layui</code>图片上传插件自带文件格式判断、大小限制以及预览功能。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> uploadInst = upload.render(&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        elem: <span class="string">'#headImg'</span> <span class="comment">//绑定元素</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">url</span>: <span class="string">'xxxx'</span> <span class="comment">//上传接口</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">method</span>: <span class="string">'post'</span>  <span class="comment">//方法</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">headers</span>: &#123;<span class="string">'X-CSRF-TOKEN'</span>: token&#125;  <span class="comment">//设置csrf-token</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">size</span>: <span class="number">1024</span> * <span class="number">10</span>  <span class="comment">//前端限制文件大小，这里为10m</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">accept</span>: <span class="string">'images'</span>  <span class="comment">//接受文件类型,这里为图片</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">data</span>: &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="string">'id'</span>: data.id,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        &#125;  <span class="comment">//同时传递题目ID</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">before</span>: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="comment">//预读本地文件示例，不支持ie8</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                            obj.preview(<span class="function"><span class="keyword">function</span> (<span class="params">index, file, result</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                $(<span class="string">'#demo1'</span>).attr(<span class="string">'src'</span>, result); <span class="comment">//图片链接（base64）</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                            &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">done</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="comment">//上传完毕回调</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="keyword">if</span> (res.code === <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                table.reload(<span class="string">'LAY-app-content-list'</span>);  <span class="comment">//表格重载</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                                layer.msg(res.message);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                layer.closeAll(<span class="string">'page'</span>);  <span class="comment">//关闭弹窗</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                <span class="keyword">return</span> layer.msg(res.message);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        , <span class="attr">error</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="comment">//请求异常回调</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                            <span class="keyword">var</span> demoText = $(<span class="string">'#demoText'</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            demoText.html(<span class="string">'&lt;span style="color: #FF5722;"&gt;上传失败&lt;/span&gt; &lt;a class="layui-btn layui-btn-mini demo-reload"&gt;重试&lt;/a&gt;'</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            demoText.find(<span class="string">'.demo-reload'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                                uploadInst.upload();</span></pre></td></tr><tr><td class="code"><pre><span class="line">                            &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    &#125;);</span></pre></td></tr></table></figure>
<p>虽然使用这个插件非常方便，但是实现这个功能还是遇到很多的坑，这里记录我解决的一个坑<br><strong>上传第一个图片正常，但是上传第二个文件的时候无反应</strong><br>原因： 在上传完，第一个图片后，上传html代码中会绑定一些元素，如果页面没有刷新的话，在进行下面的上传，会出现无反应的现象。<br>解决办法：在弹窗层销毁后，将元素重置。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">end: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">$(<span class="string">'.uploadHeadImage'</span>).empty().append(<span class="string">" &lt;div class=\"layui-upload-drag\" id=\"headImg\"&gt;\n"</span> +</span></pre></td></tr><tr><td class="code"><pre><span class="line"> <span class="string">"                    &lt;i class=\"layui-icon\"&gt;&lt;/i&gt;\n"</span> +</span></pre></td></tr><tr><td class="code"><pre><span class="line"> <span class="string">"                    &lt;p&gt;点击上传图片，或将图片拖拽到此处&lt;/p&gt;\n"</span> +</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">"                &lt;/div&gt;"</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr></table></figure>
<ul>
<li>后端</li>
</ul>
<p>后端的话，没有添加文件大小检测，其他都实现了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    file = request.files[<span class="string">'file'</span>]  <span class="comment">#获取文件</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    id = request.form.get(<span class="string">'id'</span>)  <span class="comment">#获取id</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> id:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> field.params_error(message=<span class="string">'参数缺失'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename, ALLOWED_EXTENSIONS=config.ALLOWED_PIC_EXTENSIONS):  <span class="comment">#文件类型判断</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        filename = secure_filename(file.filename)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        new_name = tools.rename(filename)  <span class="comment">#重命名</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        new_path = os.path.join(config.UPLOAD_PIC_PATH, tools.rename(filename))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        file.save(new_path)  <span class="comment">#保存文件</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        vul = Vuls.query.get(id)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> vul:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">return</span> field.params_error(message=<span class="string">'题目不存在'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        old_path = os.path.join(config.UPLOAD_PIC_PATH, vul.img)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> vul.img:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">if</span> os.path.exists(old_path):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                os.remove(old_path)  <span class="comment">#删除上一个头像</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        vul.img = new_name</span></pre></td></tr><tr><td class="code"><pre><span class="line">        db.session.commit()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> field.layui_success(message=<span class="string">'上传成功'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> field.params_error(message=<span class="string">'文件类型错误'</span>)</span></pre></td></tr></table></figure>
<p>此片文章记录了Flask实现文件上传的全过程，以供以后学习查看。</p>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>python关于时间操作</title>
    <url>/2019/12/09/python%E5%85%B3%E4%BA%8E%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>Python中时间操作使用还是挺频繁的，主要使用到<code>time</code>和<code>datetime</code>这两个库，下面记录常用的时间操作<a id="more"></a></p>
<h3 id="当前时间戳"><a href="#当前时间戳" class="headerlink" title="当前时间戳"></a>当前时间戳</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span></pre></td></tr><tr><td class="code"><pre><span class="line">ticks = time.time()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(ticks)</span></pre></td></tr></table></figure>

<h3 id="当前时间-now"><a href="#当前时间-now" class="headerlink" title="当前时间(now)"></a>当前时间(now)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line">now = datetime.datetime.now()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(now)</span></pre></td></tr></table></figure>

<h3 id="本地时间-localtime"><a href="#本地时间-localtime" class="headerlink" title="本地时间(localtime)"></a>本地时间(localtime)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span></pre></td></tr><tr><td class="code"><pre><span class="line">loacltime = time.loacltime()</span></pre></td></tr></table></figure>

<h3 id="格式化时间-strftime"><a href="#格式化时间-strftime" class="headerlink" title="格式化时间(strftime)"></a>格式化时间(strftime)</h3><ul>
<li><p>datetime</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line">now = datetime.datetime.now()</span></pre></td></tr><tr><td class="code"><pre><span class="line">strftime = now.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(strftime)</span></pre></td></tr></table></figure>
</li>
<li><p>time</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span></pre></td></tr><tr><td class="code"><pre><span class="line">now = time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime())</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(now)</span></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="时间转时间戳-timestamp"><a href="#时间转时间戳-timestamp" class="headerlink" title="时间转时间戳(timestamp)"></a>时间转时间戳(timestamp)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line">now = datetime.datetime.now()</span></pre></td></tr><tr><td class="code"><pre><span class="line">t = now.timestamp()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(t)</span></pre></td></tr></table></figure>

<h3 id="时间戳转时间-fromtimestamp"><a href="#时间戳转时间-fromtimestamp" class="headerlink" title="时间戳转时间(fromtimestamp)"></a>时间戳转时间(fromtimestamp)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span></pre></td></tr><tr><td class="code"><pre><span class="line">ticks = time.time()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(datetime.fromtimestamp(ticks))</span></pre></td></tr></table></figure>

<h3 id="时间加减-timedelta"><a href="#时间加减-timedelta" class="headerlink" title="时间加减(timedelta)"></a>时间加减(timedelta)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line">d1 = datetime.datetime.now()</span></pre></td></tr><tr><td class="code"><pre><span class="line">d2 = d1 + datetime.timedelta(hours = <span class="number">8</span>)  <span class="comment">#时间+8小时</span></span></pre></td></tr></table></figure>

<p><strong>其中可选参数:天(days), 小时(hours), 分钟(minutes), 秒(seconds), 微秒(microseconds)</strong></p>
<h3 id="开发中的操作"><a href="#开发中的操作" class="headerlink" title="开发中的操作"></a>开发中的操作</h3><ul>
<li>返回一周时间列表[‘2019-12-8’, ‘2019-12-9’,…]<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span></pre></td></tr><tr><td class="code"><pre><span class="line">today = datetime.date.today()</span></pre></td></tr><tr><td class="code"><pre><span class="line">date_list = [(today - datetime.timedelta(days=i)).strftime(<span class="string">'%Y-%m-%d'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>)]  <span class="comment">#控制天数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">date_list.reverse()</span></pre></td></tr><tr><td class="code"><pre><span class="line">print(date_list)</span></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>记Flask-Sqlalchemy一次奇葩操作</title>
    <url>/2019/12/06/%E8%AE%B0Flask-Sqlalchemy%E4%B8%80%E6%AC%A1%E5%A5%87%E8%91%A9%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>在写用户编辑的时候，进行前端过滤，只是将用户ID和更改的字段传递给后端，可以后端我并不知道哪个字段更改啊(真是自己给自己挖坑啊)现在想想是不是当时喝醉写的代码</p>
<a id="more"></a>

<blockquote>
<p>具体代码就不看了，说下个人认为正常操作吧</p>
</blockquote>
<p>正常情况下，前端正常的判断还是需要的，然后将用户的所有字段都传递过来，并不是只有更改的字段，如果只传更改字段，其实在获取各个字段的时候，将默认值改成数据库中的数据也可以操作，这里我会再写一篇文章进行详细记录，先说说这次奇葩操作。</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">name</th>
<th align="center">email</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">张三</td>
<td align="center"><a href="mailto:zhangsan@qq.com" target="_blank" rel="noopener">zhangsan@qq.com</a></td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">李四</td>
<td align="center"><a href="mailto:lisi@qq.com" target="_blank" rel="noopener">lisi@qq.com</a></td>
</tr>
</tbody></table>
<p>比如我现在用这个表，前端我需要修改张三的邮箱，而我往后端传递的参数只有<code>id</code>和修改后<code>email</code>，而后端正常更改用户数据的话，先根据<code>id</code>查询到相关用户,然后进行修改。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">user = User.query.get(id)</span></pre></td></tr><tr><td class="code"><pre><span class="line">user.email = <span class="string">'zhangsan111@qq.com'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit() <span class="comment">#提交</span></span></pre></td></tr></table></figure>
<p>可是我只传<code>email</code>和<code>id</code>的话，我可以根据<code>id</code>找到这个用户,但是再进行<code>user.xxx=xxx</code>时，我就不知道如何解决了，于是酒劲上来了，突发奇想，这样操作。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = request.values   <span class="comment">#获取返回的字典如&#123;'id':1, 'email':'zhangsan111@qq.com'&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">key = list(data.keys())  <span class="comment">#获取字典中的key如：['id', 'name']</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">key.remove(<span class="string">'id'</span>)  <span class="comment">#将列表中的id删除,应为主键不可更改</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span></pre></td></tr><tr><td class="code"><pre><span class="line">4user.__setattr__(i, data.get(i))  <span class="comment">#将列表中的其他字段通过user.__setattr__('email','zhangsan111@qq.com')进行更改，这样我就不要顾虑前端哪个字段更改了，都可以解决。</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">db.session.commit() <span class="comment">#提交</span></span></pre></td></tr></table></figure>

<p>现在看看这个操作还是想笑，后续我会关于这个实现，更新个正常点的方法。</p>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>python实现断点续传</title>
    <url>/2019/12/06/python%E5%AE%9E%E7%8E%B0%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/</url>
    <content><![CDATA[<p>在写观星资产扫描器的时候，IP定位用的是<a href="https://geoip.com/" target="_blank" rel="noopener">Geoip</a>提供的IP库实现的，每个用户在使用扫描器的时候如果本地没有IP库需要从远端进行下载,然而这个文件将近50M，为尽量减少下载的效率，采用断点续传。<a id="more"></a></p>
<blockquote>
<p>断点续传就是在上传或者下载的时候，出现网络状况，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载。用户可以节省时间，提高速度。</p>
</blockquote>
<p><strong>为简单明了的表达自己的意思，画了个流程图</strong></p>
<p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/TIM%E6%88%AA%E5%9B%BE20191206172901.png" alt="断点续传"></p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><p>首先<a href="https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz" target="_blank" rel="noopener">访问地址</a>获取文件的大小</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">req = requests.get(url=url, stream=<span class="literal">True</span>, verify=<span class="literal">False</span>, headers=&#123;<span class="string">"User-Agent"</span>: self.user_agent&#125;)</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> req.status_code == <span class="number">200</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">    total_size = int(req.headers[<span class="string">'Content-Length'</span>])  <span class="comment">#获取文件的大小</span></span></pre></td></tr></table></figure>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><p>然后判断本地是否存在这个文件，定义本地文件的大小，从而找到续传的起始字节</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> os.path.exists(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>)):</span></pre></td></tr><tr><td class="code"><pre><span class="line">    temp_size = os.path.getsize(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">    temp_size = <span class="number">0</span></span></pre></td></tr></table></figure>
<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><p>下面就是最重要的部分，重新请求头，并设置获取文件的起始字节</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">headers = &#123;<span class="string">"User-Agent"</span>: self.user_agent, <span class="string">'Range'</span>: <span class="string">'bytes=%d-'</span> % temp_size&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">re_req = requests.get(url, stream=<span class="literal">True</span>, verify=<span class="literal">False</span>, headers=headers)</span></pre></td></tr></table></figure>
<blockquote>
<p>其中说下Http请求头中的<code>Range</code>字段,这个实现断点续传的关键</p>
</blockquote>
<pre><code>Range: bytes=start-end</code></pre><p>例如</p>
<p>Range: bytes=10- ：第10个字节及最后个字节的数据</p>
<p>Range: bytes=40-100 ：第40个字节到第100个字节之间的数据.</p>
<p>注意，这个表示[start,end]，即是包含请求头的start及end字节的，所以，下一个请求，应该是上一个请求的[end+1, nextEnd]</p>
<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><p>最后判断文件的大小是否和远端文件大小相等，如果相等进行解压、提取,这部分就包含文件解压，剪切的操作,</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> temp_size == total_size:</span></pre></td></tr><tr><td class="code"><pre><span class="line">4<span class="keyword">try</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">44<span class="comment">#文件操作</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">except</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">raise</span> FileNotFoundError(<span class="string">'文件解压失败'</span>)</span></pre></td></tr></table></figure>

<h3 id="整体代码"><a href="#整体代码" class="headerlink" title="整体代码"></a>整体代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__download_and_tar_geolite</span><span class="params">(self, url=<span class="string">'https://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz'</span>)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    req = requests.get(url=url, stream=<span class="literal">True</span>, verify=<span class="literal">False</span>, headers=&#123;<span class="string">"User-Agent"</span>: self.user_agent&#125;)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> req.status_code == <span class="number">200</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        total_size = int(req.headers[<span class="string">'Content-Length'</span>])</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> os.path.exists(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>)):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            temp_size = os.path.getsize(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            temp_size = <span class="number">0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        headers = &#123;<span class="string">"User-Agent"</span>: self.user_agent, <span class="string">'Range'</span>: <span class="string">'bytes=%d-'</span> % temp_size&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        re_req = requests.get(url, stream=<span class="literal">True</span>, verify=<span class="literal">False</span>, headers=headers)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">with</span> open(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>), <span class="string">'ab'</span>) <span class="keyword">as</span> f:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">for</span> chuck <span class="keyword">in</span> re_req.iter_content(chunk_size=<span class="number">1024</span>):</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">if</span> chuck:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    temp_size += len(chuck)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    f.write(chuck)   <span class="comment">#文件保存</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                    f.flush()</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    done = int(<span class="number">50</span> * temp_size / total_size)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    sys.stdout.write(</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        <span class="string">"正在进行数据库下载(不要结束程序)：[%s%s] %d%%"</span> % (</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        <span class="string">'█'</span> * done, <span class="string">' '</span> * (<span class="number">50</span> - done), <span class="number">100</span> * temp_size / total_size))</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    sys.stdout.flush()</span></pre></td></tr><tr><td class="code"><pre><span class="line">                print()  <span class="comment"># 避免上面\r 回车符</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> temp_size == total_size:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">try</span>:   </span></pre></td></tr><tr><td class="code"><pre><span class="line">                file = tarfile.open(os.path.join(os.getcwd(), <span class="string">'dbs'</span>, <span class="string">'GeoLite2-City.tar.gz'</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">                file.extractall(path=os.path.join(os.getcwd(), <span class="string">'dbs'</span>))  <span class="comment">#文件解压</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                walk = os.listdir(os.path.join(os.getcwd(), <span class="string">'dbs'</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> walk:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                    <span class="keyword">if</span> <span class="string">'GeoLite2-City_'</span> <span class="keyword">in</span> i:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        src_path = os.path.join(os.getcwd(), <span class="string">'dbs'</span>, i, <span class="string">'GeoLite2-City.mmdb'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        des_path = os.path.join(os.getcwd(), <span class="string">'dbs'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">                        shutil.move(src_path, des_path) <span class="comment">#文件移动</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                        <span class="keyword">break</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                file.close()</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">except</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="keyword">raise</span> FileNotFoundError(<span class="string">'文件操作失败'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'文件缺失'</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">else</span>:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">raise</span> ConnectionError(<span class="string">'无法连接数据库'</span>)</span></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>常用正则表达式收集</title>
    <url>/2019/12/06/%E5%B8%B8%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%94%B6%E9%9B%86/</url>
    <content><![CDATA[<p>正则表达式的应用的地方还是挺多的，如爬虫中提取相关数据，以及web开发中用户提交数据验证，所有收集些常用的正则表达式，方便自已查找使用。</p>
<a id="more"></a>

<blockquote>
<p>网上版本很多，也不知到谁是原创，我仅提取我需要的部分，在以后，自己会继续更新更多的正则表达式，以供参考学习。</p>
</blockquote>
<h3 id="0x01-验证数字的表达式"><a href="#0x01-验证数字的表达式" class="headerlink" title="0x01 验证数字的表达式"></a>0x01 验证数字的表达式</h3><p>数字：<code>^[0-9]*$</code></p>
<p>n位的数字：<code>^d{n}$</code></p>
<p>至少n位的数字：<code>^d{n,}$</code></p>
<p>m-n位的数字：<code>^d{m,n}$</code></p>
<p>零和非零开头的数字：<code>^(0|[1-9][0-9]*)$</code></p>
<p>非零开头的最多带两位小数的数字：<code>^([1-9][0-9]*)+(.[0-9]{1,2})?$</code></p>
<p>带1-2位小数的正数或负数：<code>^(-)?d+(.d{1,2})?$</code></p>
<p>正数、负数、和小数：<code>^(-|+)?d+(.d+)?$</code></p>
<p>有两位小数的正实数：<code>^[0-9]+(.[0-9]{2})?$</code></p>
<p>有1~3位小数的正实数：<code>^[0-9]+(.[0-9]{1,3})?$</code></p>
<p>非零的正整数：<code>^[1-9]d*$</code> 或 <code>^([1-9][0-9]*){1,3}$</code> 或 <code>^+?[1-9][0-9]*$</code></p>
<p>非零的负整数：<code>^-[1-9][]0-9&quot;*$</code> 或 <code>^-[1-9]d*$</code></p>
<p>非负整数：<code>^d+$</code> 或 <code>^[1-9]d*|0$</code></p>
<p>非正整数：<code>^-[1-9]d*|0$</code> 或 <code>^((-d+)|(0+))$</code></p>
<p>非负浮点数：<code>^d+(.d+)?$</code> 或 <code>^[1-9]d*.d*|0.d*[1-9]d*|0?.0+|0$</code></p>
<p>非正浮点数：<code>^((-d+(.d+)?)|(0+(.0+)?))$</code> 或 <code>^(-([1-9]d*.d*|0.d*[1-9]d*))|0?.0+|0$</code></p>
<p>正浮点数：<code>^[1-9]d*.d*|0.d*[1-9]d*$</code> 或 <code>^(([0-9]+.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*.[0-9]+)|([0-9]*[1-9][0-9]*))$</code></p>
<p>负浮点数：<code>^-([1-9]d*.d*|0.d*[1-9]d*)$</code> 或 <code>^(-(([0-9]+.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*.[0-9]+)|([0-9]*[1-9][0-9]*)))$</code></p>
<p>浮点数：<code>^(-?d+)(.d+)?$</code> 或 <code>^-?([1-9]d*.d*|0.d*[1-9]d*|0?.0+|0)$</code></p>
<h3 id="0x02-验证字符串的表达式"><a href="#0x02-验证字符串的表达式" class="headerlink" title="0x02 验证字符串的表达式"></a>0x02 验证字符串的表达式</h3><p>汉字：<code>^[\u4e00-\u9fa5]+$</code></p>
<p>英文和数字：<code>^[A-Za-z0-9]+$</code> 或 <code>^[A-Za-z0-9]{4,40}$</code></p>
<p>长度为3-20的所有字符：<code>^.{3,20}$</code></p>
<p>由26个英文字母组成的字符串：<code>^[A-Za-z]+$</code></p>
<p>由26个大写英文字母组成的字符串：<code>^[A-Z]+$</code></p>
<p>由26个小写英文字母组成的字符串：<code>^[a-z]+$</code></p>
<p>由数字和26个英文字母组成的字符串：<code>^[A-Za-z0-9]+$</code></p>
<p>由数字、26个英文字母或者下划线组成的字符串：<code>^w+$</code> 或 <code>^w{3,20}$</code></p>
<h3 id="0x03-特殊需求表达式"><a href="#0x03-特殊需求表达式" class="headerlink" title="0x03 特殊需求表达式"></a>0x03 特殊需求表达式</h3><p>去掉左右空格:<br><code>str.replace(/(^\s*)|(\s*$)/g, &#39;&#39;)</code></p>
<p>去掉所有空格:<br><code>str.replace(/\s+/g, &#39;&#39;)</code></p>
<p>密码需由8位以上大写字母、小写字母、数字及特殊符号组成: <code>/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!.,@$%^&amp;*-]).{8,}$/</code></p>
<p>Email地址：<code>^w+([-+.]w+)*@w+([-.]w+)*.w+([-.]w+)*$</code></p>
<p>域名：[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(/.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+/.?</p>
<p>InternetURL：[a-zA-z]+://[<code>^s]* 或</code>^http://([w-]+.)+[w-]+(/[w-./?%&amp;=]*)?$`</p>
<p>手机号码：<code>^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])d{8}$</code></p>
<p>电话号码(“XXX-XXXXXXX”、”XXXX-XXXXXXXX”、”XXX-XXXXXXX”、”XXX-XXXXXXXX”、”XXXXXXX”和”XXXXXXXX)：<code>^((d{3,4}-)|d{3.4}-)?d{7,8}$</code></p>
<p>国内电话号码<code>(0511-4405222、021-87888822)：d{3}-d{8}|d{4}-d{7}</code></p>
<p>身份证号(15位、18位数字)：<code>^d{15}|d{18}$</code></p>
<p>短身份证号码(数字、字母x结尾)：<code>^([0-9]){7,18}(x|X)?$</code> 或 <code>^d{8,18}|[0-9x]{8,18}|[0-9X]{8,18}?$</code></p>
<p>帐号是否合法(字母开头，允许5-16字节，允许字母数字下划线)：<code>^[a-zA-Z][a-zA-Z0-9_]{4,15}$</code></p>
<p>密码(以字母开头，长度在6~18之间，只能包含字母、数字和下划线)：<code>^[a-zA-Z]w{5,17}$</code></p>
<p>强密码(必须包含大小写字母和数字的组合，不能使用特殊字符，长度在8-10之间)：<code>^(?=.*d)(?=.*[a-z])(?=.*[A-Z]).{8,10}$</code></p>
<p>日期格式：<code>^d{4}-d{1,2}-d{1,2}</code></p>
<p>Html中title：<code>&lt;title&gt;(.*?)&lt;/title&gt;|&lt;TITLE&gt;(.*?)&lt;/TITLE&gt;</code></p>
<p>一年的12个月(01～09和1～12)：<code>^(0?[1-9]|1[0-2])$</code></p>
<p>一个月的31天(01～09和1～31)：<code>^((0?[1-9])|((1|2)[0-9])|30|31)$</code><br>xml文件：<code>^([a-zA-Z]+-?)+[a-zA-Z0-9]+\.[x|X][m|M][l|L]$</code></p>
<p>空白行的正则表达式：<code>s*</code> (可以用来删除空白行)</p>
<p>HTML标记的正则表达式：<code>&lt;(S*?)[`^&gt;]*&gt;.*?&lt;/&gt;|&lt;.*? /&gt;</code> (网上流传的版本太糟糕，上面这个也仅仅能部分，对于复杂的嵌套标记依旧无能为力)</p>
<p>首尾空白字符的正则表达式：<code>^s*|s*$</code>或(<code>^s*)|(s*$</code>) (可以用来删除行首行尾的空白字符(包括空格、制表符、换页符等等)，非常有用的表达式)</p>
<p>腾讯QQ号：<code>[1-9][0-9]{4,}</code> (腾讯QQ号从10000开始)</p>
<p>中国邮政编码：<code>[1-9]d{5}(?!d)</code> (中国邮政编码为6位数字)</p>
<p>IP地址：<code>d+.d+.d+.d+</code> (提取IP地址时有用)</p>
<p>IP地址：<code>((?:(?:25[0-5]|2[0-4]\d|[01]?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d?\d))</code></p>
]]></content>
      <categories>
        <category>正则表达式</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>删除github误传文件</title>
    <url>/2019/12/06/%E5%88%A0%E9%99%A4github%E8%AF%AF%E4%BC%A0%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<p>在使用<code>git push</code>时，有时忘记忽略某些不必要上传的文件，从而上传到Github上，记录如何删除这些文件</p>
<a id="more"></a>

<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">git rm -r <span class="comment">--cached &lt;target&gt;</span></span></pre></td></tr></table></figure>
<p><strong>target</strong>：删除对象</p>
<p>然后进行提交</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> commit -m<span class="string">"删除target"</span></span></pre></td></tr></table></figure>

<p>最后进行上传,就可以删除Github上误传的文件了，下次再上传的话，修改忽略文件，否则还会上传。</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">push</span> <span class="built_in">origin</span> master</span></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Github</category>
      </categories>
      <tags>
        <tag>Github</tag>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>python将列表平均分成n份</title>
    <url>/2019/12/05/python%E5%B0%86%E5%88%97%E8%A1%A8%E5%B9%B3%E5%9D%87%E5%88%86%E6%88%90n%E4%BB%BD/</url>
    <content><![CDATA[<p>在开发中遇到，需要将下发的任务平均分给n个工人，如何进行分配，写个函数进行记录。</p>
<a id="more"></a>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_spilt</span><span class="params">(arr, n)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="string">'''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    将列表平均分成n份</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    :param list:  列表对象</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    :param n:  份数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    :return:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="string">    '''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(arr, list):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(n, int) <span class="keyword">or</span> n&lt;=<span class="number">0</span> <span class="keyword">or</span> <span class="keyword">not</span> str(n).isdigit():</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    length = len(arr)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    new_list = []</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        one_list = arr[math.floor(i / n * length):math.floor((i + <span class="number">1</span>) / n * length)]</span></pre></td></tr><tr><td class="code"><pre><span class="line">        new_list.append(one_list)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> new_list</span></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>PicGo+Github打造专属图床</title>
    <url>/2019/12/05/PicGo-Github%E6%89%93%E9%80%A0%E4%B8%93%E5%B1%9E%E5%9B%BE%E5%BA%8A/</url>
    <content><![CDATA[<p>Hexo搭建博客，有个缺点就是没有提供图片上传存储，而<code>PicGo</code>这个开源工具配合<code>Github</code>仓库就可以解决这个问题哦，下面我要开始了…</p>
<a id="more"></a>

<h2 id="PicGo"><a href="#PicGo" class="headerlink" title="PicGo"></a>PicGo</h2><p><a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">PicGo</a>是Github上开源的图片上传管理工具，支持MacOS、Windows以及Linux，同时支持多种图床</p>
<ul>
<li>微博图床</li>
<li>七牛图床</li>
<li>腾讯云</li>
<li>又拍云</li>
<li>Github</li>
<li>SM.MS</li>
<li>阿里云</li>
<li>Imgur</li>
</ul>
<blockquote>
<p>这个我主要介绍使用Github当做图床如何使用，虽然Github比较慢，但是白嫖还是挺舒服的嘻嘻。</p>
</blockquote>
<h2 id="PicGo-配置"><a href="#PicGo-配置" class="headerlink" title="PicGo 配置"></a>PicGo 配置</h2><ol>
<li><p>下载<a href="https://github.com/Molunerfinn/PicGo/releases" target="_blank" rel="noopener">PicGo</a>，选择符合的版本</p>
</li>
<li><p>在Github创建个仓库，用来存储图片</p>
</li>
<li><p>然后进行PicGo设置<br><img src="https://raw.githubusercontent.com/Joynice/image/master/img/TIM%E6%88%AA%E5%9B%BE20191205153724.png" alt=""></p>
<ul>
<li>设置Github创建的仓库的名称格式如：用户名/仓库名</li>
<li>设置commit分支，默认<code>master</code></li>
<li><a href="https://github.com/settings/tokens" target="_blank" rel="noopener">生成Githb Token</a>,将Token值填入</li>
<li>指定存储路径，存在仓库中生成文件夹，并存储在文件夹中</li>
<li>自定义域名没用过，gg</li>
</ul>
</li>
</ol>
<blockquote>
<p>配置好后就可以使用PicGo进行图片上传了</p>
</blockquote>
<h2 id="PicGO-使用"><a href="#PicGO-使用" class="headerlink" title="PicGO 使用"></a>PicGO 使用</h2><p>PicGo使用非常方便</p>
<ol>
<li>点击到上传区</li>
<li>上传后，到相册中就可以copy图片地址，然后粘贴就好，非常低方便</li>
</ol>
]]></content>
      <categories>
        <category>Github</category>
      </categories>
      <tags>
        <tag>PicGo</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>解决github上提交无记录</title>
    <url>/2019/12/05/%E8%A7%A3%E5%86%B3github%E4%B8%8A%E6%8F%90%E4%BA%A4%E6%97%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>使用Github时间也不久了，大学的时候经常上传些自己写的小项目和课程课设，毕业后公司项目也使用Github私有仓库进行项目托管，经常commit。但是发现Github的<code>overview</code>的提交图上并没有多少，于是记录这次排查。</p>
<a id="more"></a>

<p>首先看看私有贡献是否开启，毕竟我的好多提交都是往私有仓库提交的。发现开启的，但是并没有什么卵变化。</p>
<p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/TIM%E6%88%AA%E5%9B%BE20191205111500.png" alt="私有贡献"></p>
<p>于是排查Github上绑定的邮箱，这几个邮箱也是我经常用的，没有什么问题</p>
<p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/TIM%E6%88%AA%E5%9B%BE20191205112149.png" alt="绑定邮箱"></p>
<p>同时我提交的时候都是往<code>master</code>默认分支上提交，同时也是项目的协作者，不是<code>fork</code>的。</p>
<p>最后排查本地git配置</p>
<pre><code>git config user.email   //查看绑定的邮箱</code></pre><p><img src="https://raw.githubusercontent.com/Joynice/image/master/img/TIM%E6%88%AA%E5%9B%BE20191205145229.png" alt=""></p>
<p>起初没有发现什么，但是仔细一看<code>foxmail</code>少了<code>l</code>，太沙雕了，于是把这个少了<code>l</code>的邮箱绑定到Github上，同时本地修改配置</p>
<pre><code>git config --global user.email &quot;xxx&quot; //email</code></pre><p>这样重新以后commit就会以重新配置的邮箱进行提交。</p>
<p>写到这里还是有个疑问，我如果删除Github上那个错误的邮箱，我的以错误邮箱进行的commit记录还有吗？这里还没敢测试。</p>
<p>总结下可能导致这个问题的原因</p>
<ul>
<li>没有往默认分支及<code>master</code>分支上commit</li>
<li>commit的仓库为Fork的仓库，并不是独立仓库</li>
<li>私有贡献没有开启</li>
<li>Github上绑定的邮箱与本地Git配置邮箱不相同（我出现的问题）</li>
</ul>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Github</tag>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo常用命令</title>
    <url>/2019/12/05/Hexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>在大二的时候就用<code>Hexo</code>搭建过自己的博客，但是后来接触到各种博客平台，就没在使用Hexo，一方面在国内访问速度有点慢，另一方面写一篇文章进行的步骤过于繁杂。但是工作后，发现好多大佬都有自己独立的博客（向大佬学习），于是重新捡起自己遗弃很久的博客。</p>
<a id="more"></a>
<p><strong>同时感谢<a href="https://bjj.dropsec.xyz/" target="_blank" rel="noopener">AJay13</a>帮我搭建<code>next</code>主题</strong></p>
<ol>
<li>hexo init</li>
</ol>
<p>命令主要用于初始化本地文件夹为博客的根目录</p>
<pre><code>hexo init [floder]</code></pre><p><code>floder</code>为可选参数，用于指定初始化目录路径，若不指定默认为当前目录</p>
<ol start="2">
<li>hexo new</li>
</ol>
<p>命令主要英语创建文章，可以简写为<code>hexo n</code></p>
<pre><code>hexo new post &lt;title&gt;</code></pre><p><code>title</code>为文章标题，如果参数中存在空格，则使用双引号包裹。命令执行后，会在<code>sourse/_post/</code>目录下生成指定标题的md文件，在此文件中编写文章即可。</p>
<ol start="3">
<li>hexo generate</li>
</ol>
<p>命令主要生成本地静态文件，一般可以简写为<code>hexo g</code></p>
<pre><code>hexo generate</code></pre><p>同时可以搭配<code>-d</code>使用，生成本地文件并上传部署，这样在博客上就可以看到更新的内容。</p>
<ol start="4">
<li>hexo server</li>
</ol>
<p>命令用于开启本地服务器，可以本地调试，一般可以简写<code>hexo s</code></p>
<pre><code>hexo server</code></pre><ul>
<li><code>-p</code>: 指定服务器端口，默认4000</li>
<li><code>-i</code>: 指定服务器IP地址，默认0.0.0.0</li>
<li><code>-s</code>: 静态模式，仅提供public文件夹中的文件禁用文件监视</li>
</ul>
<ol start="5">
<li>hexo deploy</li>
</ol>
<p>命令主要用于部署远端网站，一般可以简写<code>hexo d</code></p>
<pre><code>hexo deploy</code></pre><p>同时在使用该命令前，要在<code>_config.yml</code>文件中修改git配置</p>
<pre><code>deploy:
    type: git
    repo: &lt;repository url&gt;
    branch: master
    message: 自定义提交消息，默认为Site updated: {{ now('YYYY-MM-DD HH:mm:ss') }}</code></pre><ol start="6">
<li>hexo clean</li>
</ol>
<p>命令主要用于清理缓存文件，网站存在异常时可以尝试此操作</p>
<pre><code>hexo clean</code></pre><ol start="7">
<li>option</li>
</ol>
<p>其他参数</p>
<ul>
<li>hexo –safe</li>
</ul>
<p>表示安全模式，用于禁用加载插件和脚本</p>
<ul>
<li>hexo –debug</li>
</ul>
<p>表示调试模式，用于将消息详细记录到终端和<code>debug.log</code>文件</p>
<ul>
<li>hexo –slient</li>
</ul>
<p>表示静默模式，用于静默输出到终端</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu设置静态IP地址</title>
    <url>/2019/12/04/ubuntu%E8%AE%BE%E7%BD%AE%E9%9D%99%E6%80%81IP%E5%9C%B0%E5%9D%80/</url>
    <content><![CDATA[<p>最近在Esxi中配置<code>ubuntu18.04 server</code>记录如何配置静态IP<a id="more"></a>。因为<code>ubuntu18.04</code>的网络管理程序使用<code>netplan</code>来管理，所有配置方式也更改了。</p>
<p>查看本机IP</p>
<pre><code>ifconfig -a</code></pre><p>查看当前配置文件</p>
<pre><code>cat /etc/netplan/50-cloud-init.yaml</code></pre><p>如果要使用静态IP的话，需要修改为下面的样子：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This file is generated from information provided by</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># the datasource.  Changes to it will not persist across an instance.</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># To disable cloud-init's network configuration capabilities, write a file</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># network: &#123;config: disabled&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">network:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">ethernets:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">enp0s3:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">addresses:</span> <span class="string">[192.168.199.101/24,</span> <span class="string">]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">dhcp4:</span> <span class="literal">no</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">dhcp6:</span> <span class="literal">no</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">gateway4:</span>  <span class="number">192.168</span><span class="number">.199</span><span class="number">.1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">            <span class="attr">nameservers:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                <span class="attr">addresses:</span> <span class="string">[8.8.8.8,</span> <span class="number">9.9</span><span class="number">.9</span><span class="number">.9</span><span class="string">]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">version:</span> <span class="number">2</span></span></pre></td></tr></table></figure>
<p>将上述配置改成自己的IP、网关、DNS，最后运行生效配置。</p>
<pre><code>netplan apply</code></pre>]]></content>
      <categories>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>运维</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu更换apt源</title>
    <url>/2019/12/04/ubuntu%E6%9B%B4%E6%8D%A2apt%E6%BA%90/</url>
    <content><![CDATA[<p>将ubuntu的apt设置为国内的源（阿里）</p>
<a id="more"></a>
<ol>
<li>备份系统自带源<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">mv <span class="regexp">/etc/</span>apt<span class="regexp">/sources.list /</span>etc<span class="regexp">/apt/</span>sources.list.bak</span></pre></td></tr></table></figure></li>
<li>修改/etc/apt/sources.list文件<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">vim</span> /etc/apt/sources.<span class="keyword">list</span></span></pre></td></tr></table></figure>
加入如下内容:<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//archive.ubuntu.com/ubuntu xenial main restricted #Added by software-properties</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial main restricted</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial main restricted multiverse universe #Added by software-properties</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe #Added by software-properties</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial universe</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-updates universe</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial multiverse</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse #Added by software-properties</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//archive.canonical.com/ubuntu xenial partner</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//archive.canonical.com/ubuntu xenial partner</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-security main restricted</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb-src <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe #Added by software-properties</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-security universe</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">deb <span class="string">http:</span><span class="comment">//mirrors.aliyun.com/ubuntu/ xenial-security multiverse</span></span></pre></td></tr></table></figure></li>
<li>更新生效<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">apt-<span class="keyword">get</span> <span class="keyword">update</span></span></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>运维</tag>
      </tags>
  </entry>
  <entry>
    <title>python获取网站IP以及识别IP位置</title>
    <url>/2019/12/04/python%E8%8E%B7%E5%8F%96%E7%BD%91%E7%AB%99IP%E4%BB%A5%E5%8F%8A%E8%AF%86%E5%88%ABIP%E4%BD%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>在一次开发过程中，需要获取网站的IP，以及改IP所在的地址。<br>第一个想法就是使用第三方接口，但是想想，还是自己实现比较实在，网上百度了一下，还是有些教程，所以就写篇文章记录下如何实现。</p>
<a id="more"></a>
<h3 id="获取IP"><a href="#获取IP" class="headerlink" title="获取IP"></a>获取IP</h3><p>在我们访问网站时，大多实用的域名进行访问，但是在项目开发过程中，我需要获得网站域名所绑定的IP地址，因为项目中导入了<code>requests</code>库，就想百度下<code>requests</code>是否能够实现这个功能。<br><img src="https://upload-images.jianshu.io/upload_images/14106334-5e259793be6c1d0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="网站IP"><br>经过一番搜索终于找到相关的信息，具体实现如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span></pre></td></tr><tr><td class="code"><pre><span class="line">req = requests.get(<span class="string">'url'</span>,stream = <span class="literal">True</span>)</span></pre></td></tr><tr><td class="code"><pre><span class="line">ip_and_port = req.raw._connection.sock.getpeername() <span class="comment">#返回元组，(ip, port)</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">text = req.text</span></pre></td></tr></table></figure>
<p>这样就可以在一次请求获得所有想要的信息。</p>
<h3 id="获取IP所在地理位置"><a href="#获取IP所在地理位置" class="headerlink" title="获取IP所在地理位置"></a>获取IP所在地理位置</h3><p>刚才的需求解决了，那么得到<code>IP</code>，我就想获得IP地址所在的位置如：<code>国家</code>、<code>城市</code>等等，本想这个功能应该只能调用第三方接口了吧，但是谷歌一下，发现python中有实现这个功能的库<a href="https://pypi.org/project/geoip2/" target="_blank" rel="noopener">geoip2</a>，简单的浏览下它的官网，发现他们实现这个功能就是基于数据库比对，可以实现以下功能：</p>
<ul>
<li>IP位置查询</li>
<li>IP是否高匿，解析真实地址</li>
<li>域名查询</li>
<li>连接方式查询</li>
<li>ASD查询</li>
<li>ISP查询</li>
</ul>
<p>这些功能的实现重要依靠相应的数据库匹配进行实现的，我们的使用方法也很简单，<code>geoip2</code>支持两种方式匹配数据库，一种是使用在线的数据库，但是考虑到对方的库在国外，可能耗时较大，所以选择将数据库下载下来，进行使用，下面的例子以查询IP所在位置进行记录。<br>先安装<code>geoip2</code>库</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> geoip2</span></pre></td></tr></table></figure>
<p>然后，数据库下载地址（包括db和csv两种格式，建议下载db格式的，如果你要看其中内容可以下载csv）：<br>          <a href="http://dev.maxmind.com/geoip/geoip2/geolite2" target="_blank" rel="noopener">http://dev.maxmind.com/geoip/geoip2/geolite2</a></p>
<p>下面用代码说话：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> geoip2.database</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_address</span><span class="params">(ip)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    reader = geoip2.database.Reader(<span class="string">'./dbs/GeoLite2-City.mmdb'</span>) <span class="comment">#这里参数为刚才下载数据库的位置</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    respone = reader.city(ip)   </span></pre></td></tr><tr><td class="code"><pre><span class="line">    Country = respone.country.name  <span class="comment">#获取国家</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Province = response.subdivisions.most_specific.name <span class="comment">#获取省</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    City = response.city.name  <span class="comment">#获取市</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    Longitude_And_Latitude = <span class="string">'Longitude:&#123;&#125;，Latitude：&#123;&#125;'</span>.format(response.location.longitude, response.location.latitude)  <span class="comment">#获取经纬度</span></span></pre></td></tr></table></figure>
<p>这样就可以获取到IP的所在位置了，这里返回的结果为英文，如果想要返回中文的话，选择地区即可，如获取国家的中文名称<code>response.country.names[&#39;zh-CN&#39;]</code>。</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu16.04-desktop-shell切换</title>
    <url>/2019/12/04/ubuntu16-04-desktop-shell%E5%88%87%E6%8D%A2/</url>
    <content><![CDATA[<p><code>Ubuntu</code>主要有<code>桌面版</code>和<code>Server版</code>两种，以前开发部署主要使用的是<code>Server版</code>，两种版本在外在最大的区别就是在与界面显示，<code>Server版</code>主要就是命令行显示，而桌面版更多版功能用界面的形式展现出来。<a id="more"></a>这次为了在Linux下练习使用<code>Docker</code>在本机上安装了一个<code>ubuntu-16.04.1-desktop-amd64</code>的桌面版的虚拟机 。但是在使用过程中发现做侧面的任务框没有了，右击鼠标也没有<code>Terminal</code>，本来想要卸载，但是想想辛辛苦苦装的，于是找找这台虚拟机其他利用价值，发现界面版还能切换至命令行版，所以果断切换。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14106334-590439d6171532a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="不显示侧面以及无法打开Terminal"></p>
<p>在桌面版中按<em>CTRL+ALT+F1</em>就可以切换至命令行模式，单这种情况下，图形界面GUI是在后台运行着，按<em>CTRL+ALT+F7</em>会切换回来。我们可以在系统引导启动时，按<em>CTRL+ALT+F7</em>这样就不会进入进入图形界面了。</p>
<p>桌面版默认没有安装ssh服务端，通过安装服务端可以使用<code>Xshell</code>进行连接，因为自带的命令行使用不习惯，可以执行以下步骤来安装：</p>
<ol>
<li><p><strong>安装ssh服务端</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install openssh-server</span></pre></td></tr></table></figure></li>
<li><p><strong>确认ssh-server是否启动</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -e|grep ssh</span></pre></td></tr></table></figure>
<p>如果只有ssh-agent那ssh-server还没有启动，需要/etc/init.d/ssh start，如果看到sshd那说明ssh-server已经启动了</p>
</li>
<li><p><strong>启动ssh-server</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ssh start</span></pre></td></tr></table></figure></li>
<li><p><strong>SSH配置(若需要)</strong><br>修改配置文件/etc/ssh/sshd_config，这里可以定义SSH的服务端口，默认端口是22，你可以自己定义成其他端口号如32，然后重启服务</p>
</li>
<li><p><strong>重启ssh-server</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;init.d&#x2F;ssh restart</span></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>运维</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Ajax中traditonal参数作用</title>
    <url>/2019/12/04/Ajax%E4%B8%ADtraditonal%E5%8F%82%E6%95%B0%E4%BD%9C%E7%94%A8/</url>
    <content><![CDATA[<p>在写Flask的时候遇到这样的问题，前端使用<code>Ajax</code>传递数据的时候，要不是数字类型，要不就是字符串，没有传递过数组(在<code>js</code>中的叫法，python中交列表，但是使用效果基本相同。)等复杂的数据类型。</p>
<a id="more"></a>
<p>这次场景中就遇到了这个问题，比如批量删除文章时，我需要传递多个文章的ID，需要一个数据类型包裹这些ID。前端知识不足的我，之前都是先存成一个数组，将这些ID <code>push</code>到数组中，然后再用某个特殊符号（我通常使用<code>,</code>）来<code>join</code>成字符串，传递给后端。这样就出现了好多麻烦的地方：</p>
<ul>
<li>前端代码过于冗杂</li>
<li>前后端需要商量拼接字符串,如我常用的<code>,</code>字符,还好前后端我都写，这个麻烦可能在我这不算问题</li>
<li>后端需要的过滤条件增多</li>
</ul>
<p>直到找到<code>Ajax</code>中的<code>traditional</code>参数，完全可以解决上面麻烦。</p>
<p>在<code>Ajax</code>的参数中<code>traditional</code>参数默认<code>false</code>,在这个状态下，data中的value数据类型只支持数字、字符串，如果设置为<code>true</code>就可以支持数字以及字典了，其中的关系到序列化的问题。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"> $.ajax&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">  url:<span class="string">"xxxx"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">  traditional: <span class="literal">true</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">  data:&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        p: values </span></pre></td></tr><tr><td class="code"><pre><span class="line">4  &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>同时Flask也有函数专门接受数组数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = request.form.getlist(<span class="string">'p'</span>)  <span class="comment">#p就是传递的列表</span></span></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>Ajax</tag>
        <tag>Flask</tag>
      </tags>
  </entry>
  <entry>
    <title>Python生成词云</title>
    <url>/2019/12/04/Python%E7%94%9F%E6%88%90%E8%AF%8D%E4%BA%91/</url>
    <content><![CDATA[<p>词云，就是对网络文本中出现频率较高的“关键词”予以视觉上的突出，形成“关键词云层”或“关键词渲染”，从而过滤掉大量的文本信息，使浏览网页者只要一眼扫过文本就可以领略文本的主旨。</p>
<a id="more"></a>
<p>说实在的就是一张图片，包含各种词汇，而词汇的大小根据出现的出现的频率决定的。这张图就是我根据爬取微信公众号近3w篇文章的标题，进行分词后，生成的一张词云。<br><img src="https://upload-images.jianshu.io/upload_images/14106334-9e915149123cc511.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="网络安全"><br>如果自己制作这张图感觉不从下手，但是有了Python在，简直分分钟的事。首先我们安装<code>wordcloud</code>这个生成词云的库，以及中文分词的库<code>jieba</code>，然后导入绘图的库<code>matplotlib</code></p>
<pre><code>pip install wordcloud
pip install jieba
pip install matplotlib</code></pre><p>然后代码说话：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba.analyse</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">image</span><span class="params">(top)</span>:</span>   <span class="comment">#词云中词汇个数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    articles = WechatArticle.query.with_entities(WechatArticle.title).all()   <span class="comment">#获取title数据</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    text = <span class="string">','</span>.join([i.title <span class="keyword">for</span> i <span class="keyword">in</span> articles])    <span class="comment">#进行数据拼接</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    result = jieba.analyse.textrank(text,topK=int(top),withWeight=<span class="literal">True</span>)   <span class="comment">#进行中文分词，并根据传入的词汇个数，产生多少个词汇，并返回各个词汇的比重。</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    keywords = dict()</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result:</span></pre></td></tr><tr><td class="code"><pre><span class="line">        keywords[i[<span class="number">0</span>]] = i[<span class="number">1</span>]  <span class="comment">#生成字典，&#123;'keyword':weight&#125;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    wc = WordCloud(font_path=<span class="string">'./utils/captcha/simhei.ttf'</span>,max_words=int(top), width=<span class="number">805</span>, height=<span class="number">304</span>)  <span class="comment">#实例词云,传入字体路径，最大的词汇数，以及词云的宽高，这里的话如果不传入字体的话，找不到字体，就会出现框框的情况。</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    wc.generate_from_frequencies(keywords) <span class="comment">#传入关键字</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    plt.imshow(wc) <span class="comment">#进行绘图</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    plt.axis(<span class="string">"off"</span>) <span class="comment">#去除X轴</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    wc.to_file(<span class="string">'./static/front/img/dream.png'</span>)  <span class="comment">#保存图片</span></span></pre></td></tr></table></figure>
<p>一番操作后，就能生成上面的词云了，其实在词云生成的样式也可以变化的，可以生成这样的也就需要加个中国地图的背景图片。<br><img src="https://upload-images.jianshu.io/upload_images/14106334-d7b23d70e09849ad.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="有形状的词云"></p>
<p><strong>有需要，但是不懂的代码的小伙伴，可以私信我，免费帮忙哦，么么哒。</strong></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>词云</tag>
      </tags>
  </entry>
  <entry>
    <title>Flask数据可视化</title>
    <url>/2019/12/03/Flask%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/</url>
    <content><![CDATA[<p>在Web开发过程中遇到要做些数据可视化工作，对于我来说，基本上后端使用<a href="https://pyecharts.org/#/" target="_blank" rel="noopener">Pyecharts</a>配合着前端<code>echarts.js</code>实现数据可视化工作。</p>
<a id="more"></a>
<h3 id="Pyechats介绍"><a href="#Pyechats介绍" class="headerlink" title="Pyechats介绍"></a>Pyechats介绍</h3><p><strong>✨ 特性</strong></p>
<ul>
<li>简洁的 API 设计，使用如丝滑般流畅，支持链式调用</li>
<li>囊括了 30+ 种常见图表，应有尽有</li>
<li>支持主流 Notebook 环境，Jupyter Notebook 和 JupyterLab</li>
<li>可轻松集成至 Flask，Django 等主流 Web 框架</li>
<li>高度灵活的配置项，可轻松搭配出精美的图表</li>
<li>详细的文档和示例，帮助开发者更快的上手项目</li>
<li>多达 400+ 地图文件以及原生的百度地图，为地理数据可视化提供强有力的支持</li>
</ul>
<p><strong>版本</strong><br>Pyechats有两个大版本，分为<code>v0.5.X</code>和v1。这两个版本像<code>python2</code>和<code>python3</code>一样相互不兼容，而且v1版本使用了python3.6+更新新的语法特性，所以v1版本只支持python3.6+。</p>
<h3 id="Pyecharts使用"><a href="#Pyecharts使用" class="headerlink" title="Pyecharts使用"></a>Pyecharts使用</h3><p>在Web开发过程中，两个版本的Pyechats都使用过，使用的场景也不同。</p>
<h4 id="场景一：Top10柱状图展示"><a href="#场景一：Top10柱状图展示" class="headerlink" title="场景一：Top10柱状图展示"></a>场景一：Top10柱状图展示</h4><p>在一次爬虫数据展示中，爬取<a href="[http://www.shicimingju.com/](http://www.shicimingju.com/)">诗词名句网</a>中诗人作品，并将作品数量前十的诗人展示出来。那时，还是第一次使用pyechats，使用的是<code>0.5.1</code>版本，可以说，第一次接触可视化工具，对于前端知识不怎么了解的我，使用起来还是非常方便的。对于这个场景，通过导入相应的图表如使用如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Bar     柱状图</span></pre></td></tr><tr><td class="code"><pre><span class="line">Pie     饼状图</span></pre></td></tr><tr><td class="code"><pre><span class="line">Line    折线图</span></pre></td></tr></table></figure>
<p>主要使用这些图，还有其他图表如：<code>Funnel（漏斗图）</code>、<code>Gauge（仪表盘）</code>等等，如果有需要，详情请见<a href="https://05x-docs.pyecharts.org/#/zh-cn/charts_base" target="_blank" rel="noopener">Pyechats基本图表</a></p>
<ul>
<li>后端</li>
</ul>
<ol>
<li>导入柱状图表<code>Bar</code>类，以及页面<code>Page</code>类<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> Bar, Page</span></pre></td></tr></table></figure></li>
<li>定义一个函数，从数据库中查询数据，返回返回Bar的实例<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bar</span><span class="params">()</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    poets = Poet.query.order_by(Poet.num.desc()).limit(<span class="number">10</span>)  <span class="comment">#获取诗人作品量前十的诗人</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    attr_poet = []    <span class="comment">#定义x轴数据，诗人姓名</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    num_poet = []   <span class="comment">#定义y轴数据，诗人作品数</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">for</span> poet <span class="keyword">in</span> poets:   </span></pre></td></tr><tr><td class="code"><pre><span class="line">        attr_poet.append(poet.name)   <span class="comment">#填充x轴数据</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        num_poet.append(poet.num)      <span class="comment">#填充y轴数据</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    bar = Bar(<span class="string">"作诗数前十名诗人"</span>)    <span class="comment">#实例</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    bar.add(<span class="string">""</span>, attr_poet, num_poet, is_label_show=<span class="literal">True</span>, center=[<span class="number">50</span>,<span class="number">50</span>])  <span class="comment">#将数据添加</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> bar   <span class="comment">#返回实例</span></span></pre></td></tr></table></figure></li>
<li>在视图中渲染给前端<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/search/')</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">()</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    page = Page()  <span class="comment">#创建一个页面实例</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    bar = get_bar()   <span class="comment">#执行函数，得到Bar实例</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    page.add(bar)   <span class="comment">#将图表添加带页面类中，如果页面中有多个图：page.add([bar1, bar2, ....])</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'search.html'</span>, chart=page.render_embed())  <span class="comment">#渲染页面,返回chart</span></span></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>前端</li>
</ul>
<ol>
<li>导入echarts.js<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='js/echarts.min.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></pre></td></tr></table></figure></li>
<li>在相应位置使用Jinja2语法引用chart<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#123;&#123; chart|safe &#125;&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr></table></figure>
这样就实现数据展示，展示如下：<br><img src="https://upload-images.jianshu.io/upload_images/14106334-1e078578cbae62ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="作诗数前十诗人"><br>如果有兴趣研究项目地址如下：<a href="[https://github.com/Joynice/shicimingju](https://github.com/Joynice/shicimingju)">shicimingju</a></li>
</ol>
<h4 id="场景二：数据实时展示"><a href="#场景二：数据实时展示" class="headerlink" title="场景二：数据实时展示"></a>场景二：数据实时展示</h4><p>在近期的项目中，遇到了要实时更新的数据，类似实时展示24小时用户在线数量，这样的话每一个小时都要向后端请求一次数据，然后重新渲染图表，实现效果如下;<br><img src="https://upload-images.jianshu.io/upload_images/14106334-a74cd3546b8bc254.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="今日在线人数"><br>配合着<code>Layui</code>的轮播图展示，为了实现这个功能，我使用了<code>v1</code>的版本，这个相比于<code>0.5</code>版本，这个版本的实现效果更佳深入用户体验。实现这个功能使用Pyecharts也非常方便。</p>
<ul>
<li>后端<br>因为<code>v1</code>版本对代码进行了重构，所有导包方式也发生了变化</li>
</ul>
<ol>
<li>新版本的Pyecharts将图表封装到<code>pyecharts.charts</code>这个文件中,将配置封装到<code>options</code>文件中，将两者分开，所以导包时：<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> options <span class="keyword">as</span> opts</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyecharts.charts <span class="keyword">import</span> Line</span></pre></td></tr></table></figure></li>
<li>与<code>0.5</code>版本类似，首先写个函数创建图表，由于还没正式上线，所以为假数据。<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar_base</span><span class="params">()</span> -&gt; Line:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    c = (</span></pre></td></tr><tr><td class="code"><pre><span class="line">        Line()</span></pre></td></tr><tr><td class="code"><pre><span class="line">            .add_xaxis(xaxis_data=list(map(<span class="keyword">lambda</span> x: <span class="string">'&#123;&#125;:00'</span>.format(x), [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">25</span>)])))</span></pre></td></tr><tr><td class="code"><pre><span class="line">            .add_yaxis(<span class="string">"在线人数"</span>, [random.randint(<span class="number">25</span>, <span class="number">150</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">25</span>)], is_smooth=<span class="literal">True</span>, color=<span class="string">'#66CDAA'</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                       label_opts=opts.LabelOpts(is_show=<span class="literal">False</span>))</span></pre></td></tr><tr><td class="code"><pre><span class="line">            .set_series_opts(</span></pre></td></tr><tr><td class="code"><pre><span class="line">            areastyle_opts=opts.AreaStyleOpts(opacity=<span class="number">0.5</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        )</span></pre></td></tr><tr><td class="code"><pre><span class="line">            .set_global_opts(</span></pre></td></tr><tr><td class="code"><pre><span class="line">            title_opts=opts.TitleOpts(title=<span class="string">"今日在线人数"</span>, pos_left=<span class="string">'43%'</span>, pos_top=<span class="string">'8%'</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">            xaxis_opts=opts.AxisOpts(</span></pre></td></tr><tr><td class="code"><pre><span class="line">                axistick_opts=opts.AxisTickOpts(is_align_with_label=<span class="literal">True</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">                is_scale=<span class="literal">False</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                boundary_gap=<span class="literal">False</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">            ),</span></pre></td></tr><tr><td class="code"><pre><span class="line">            legend_opts=opts.LegendOpts(is_show=<span class="literal">False</span>),</span></pre></td></tr><tr><td class="code"><pre><span class="line">        )</span></pre></td></tr><tr><td class="code"><pre><span class="line">    )</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> c</span></pre></td></tr></table></figure></li>
<li>定义一个视图函数进行，进行与前端交互<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@bp.route("/barChart")</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_bar_chart</span><span class="params">()</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    c = bar_base()</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> c.dump_options()</span></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>前端</li>
</ul>
<ol>
<li><p>引用echarts.js</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; url_for('static', filename='common/echarts.min.js') &#125;&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></pre></td></tr></table></figure>
</li>
<li><p>结合<code>Layui</code>的轮播图，将生成的图表放入轮播图中</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"layui-carousel"</span> <span class="attr">id</span>=<span class="string">"test1"</span> <span class="attr">lay-filter</span>=<span class="string">"test1"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">carousel-item</span>=<span class="string">""</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"bar"</span> <span class="attr">style</span>=<span class="string">"background-image: url('&#123;&#123; static('admin/img/timg.gif') &#125;&#125;');"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                     <span class="tag">&lt;<span class="name">div</span>&gt;</span>条目2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                     <span class="tag">&lt;<span class="name">div</span>&gt;</span>条目3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                      <span class="tag">&lt;<span class="name">div</span>&gt;</span>条目4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">                      <span class="tag">&lt;<span class="name">div</span>&gt;</span>条目5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">               <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></pre></td></tr></table></figure></li>
<li><p>通过JS实现AJAX轮询操作</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">var</span> chart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'bar'</span>), <span class="string">'essos'</span>, &#123;<span class="attr">renderer</span>: <span class="string">'canvas'</span>&#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="built_in">window</span>.onresize = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">      chart.resize();</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    chart.setOption(&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">        toolbox: &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            show: <span class="literal">true</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">            feature: &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                mark: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                dataView: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">readOnly</span>: <span class="literal">false</span>&#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                magicType: &#123;<span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">type</span>: [<span class="string">'line'</span>, <span class="string">'bar'</span>, <span class="string">'stack'</span>, <span class="string">'tiled'</span>]&#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                restore: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">                saveAsImage: &#123;<span class="attr">show</span>: <span class="literal">true</span>&#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        &#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    $(</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            fetchData(chart);</span></pre></td></tr><tr><td class="code"><pre><span class="line">            setInterval(fetchData, <span class="number">1000</span> * <span class="number">60</span>);</span></pre></td></tr><tr><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    );</span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fetchData</span>(<span class="params"></span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        $.ajax(&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">            type: <span class="string">"GET"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">            url: <span class="string">"/barChart"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">            dataType: <span class="string">'json'</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">            success: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">                chart.setOption(result);</span></pre></td></tr><tr><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        &#125;);</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;);</span></pre></td></tr></table></figure>
<p>这样就可以实现相应的功能了。</p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在开发过程中，使用过多次<code>Pyecharts</code>，通过记录这两次场景应用，方便以后的学习，数据可视化还需要更深入的研究，以后还会继续学习相关知识。</p>
]]></content>
      <categories>
        <category>Flask</category>
      </categories>
      <tags>
        <tag>Flask</tag>
        <tag>Echarts</tag>
      </tags>
  </entry>
  <entry>
    <title>常规漏洞处置方案</title>
    <url>/2019/12/03/%E5%B8%B8%E8%A7%84%E6%BC%8F%E6%B4%9E%E5%A4%84%E7%BD%AE%E6%96%B9%E6%A1%88/</url>
    <content><![CDATA[<p>收集下常规漏洞处置方案，在生产环境中，基本上首先都要封禁攻击者IP。</p>
<a id="more"></a>

<h3 id="内网IP攻击"><a href="#内网IP攻击" class="headerlink" title="内网IP攻击"></a>内网IP攻击</h3><p>升级免疫网络，基因式终端网卡绑定，对身份严格控制审计，对发出的任何数据做到严格验证封包。</p>
<h3 id="structs2远程命令执行漏洞"><a href="#structs2远程命令执行漏洞" class="headerlink" title="structs2远程命令执行漏洞"></a>structs2远程命令执行漏洞</h3><p>升级Struct2框架，在不影响业务前提下，对lib目录中对应jar包进行替换。</p>
<h3 id="注入攻击"><a href="#注入攻击" class="headerlink" title="注入攻击"></a>注入攻击</h3><p>封禁攻击IP，对用户输入进行验证，过滤特殊字符，使用类型安全的sql参数，业务代码中检测注入点。</p>
<h3 id="跨站攻击"><a href="#跨站攻击" class="headerlink" title="跨站攻击"></a>跨站攻击</h3><p>封禁攻击IP，对于存储型攻击，找到业务代码进行修复，过滤特殊字符串，严格检测用户输入，对用户上传文件进行检测。</p>
<h3 id="Web插件漏洞攻击"><a href="#Web插件漏洞攻击" class="headerlink" title="Web插件漏洞攻击"></a>Web插件漏洞攻击</h3><p>封禁攻击IP，对系统使用的Web插件进行定期插件检测，使用安全的Web插件，关注相关插件漏洞。</p>
<h3 id="Webshell攻击"><a href="#Webshell攻击" class="headerlink" title="Webshell攻击"></a>Webshell攻击</h3><p>封禁攻击IP，及时删除攻击文件，配置好服务器FSO权限，对asp上传文件进行严格审核，设置上传白名单。</p>
<h3 id="弱口令探测"><a href="#弱口令探测" class="headerlink" title="弱口令探测"></a>弱口令探测</h3><p>封禁探测IP，系统可以采取动态口令验证，定期更改口令，系统强制使用强口令。</p>
<h3 id="Web漏洞扫描"><a href="#Web漏洞扫描" class="headerlink" title="Web漏洞扫描"></a>Web漏洞扫描</h3><p>封禁攻击IP，使用第三方的防御策略来设置过滤。</p>
<h3 id="口令爆破"><a href="#口令爆破" class="headerlink" title="口令爆破"></a>口令爆破</h3><p>封禁探测IP，系统可以采取动态口令验证，定期更改口令，系统强制使用强口令。</p>
<h3 id="命令执行攻击"><a href="#命令执行攻击" class="headerlink" title="命令执行攻击"></a>命令执行攻击</h3><p>封禁攻击IP，对敏感字符进行转义，对参数进行过滤，系统少用或者禁用命令执行函数。</p>
<h3 id="Sql注入攻击"><a href="#Sql注入攻击" class="headerlink" title="Sql注入攻击"></a>Sql注入攻击</h3><p>封禁攻击IP，查询语句使用数据库提供的参数化查询接口，对特殊字符进行转义或者编码处理，严格限制变量类型、数据长度以及操作权限。</p>
<h3 id="社会工程学攻击"><a href="#社会工程学攻击" class="headerlink" title="社会工程学攻击"></a>社会工程学攻击</h3><p>保证数据库安全，防止被暴库泄露用户信息，重视邮件系统信息以及用户敏感信息保护。</p>
<h3 id="网络钓鱼攻击"><a href="#网络钓鱼攻击" class="headerlink" title="网络钓鱼攻击"></a>网络钓鱼攻击</h3><p>各类文章链接或文件一律不点击、不查看、不下载、不传播。</p>
<h3 id="Apache-Tomcat-远程代码执行攻击"><a href="#Apache-Tomcat-远程代码执行攻击" class="headerlink" title="Apache Tomcat 远程代码执行攻击"></a>Apache Tomcat 远程代码执行攻击</h3><p>封禁攻击IP，根据厂商进行升级补丁修复漏洞。</p>
<h3 id="RDP爆破攻击"><a href="#RDP爆破攻击" class="headerlink" title="RDP爆破攻击"></a>RDP爆破攻击</h3><p>封禁攻击IP，根据业务需求，关闭没必要RDP服务，更新RDP版本，系统账号设置强密码，限制密码尝试次数。</p>
<h3 id="挖矿木马攻击"><a href="#挖矿木马攻击" class="headerlink" title="挖矿木马攻击"></a>挖矿木马攻击</h3><p>封禁攻击IP，找到木马来源，切断入口；找到木马守护进程并杀死，然后杀死木马进程；持续监视服务器资源消耗，发现异常进程及时处置。</p>
<h3 id="勒索病毒"><a href="#勒索病毒" class="headerlink" title="勒索病毒"></a>勒索病毒</h3><p>1.断网处理，防止勒索病毒内网传播感染，造成更大的损失；</p>
<p>2.查找样本和勒索相关信息，确认是哪个勒索病毒家族的样本；</p>
<p>3.确认完勒索病毒家族之后，看看是否有相应的解密工具，可以进行解密；</p>
<p>4.进行溯源分析，确认是通过哪种方式传播感染的进来的，封堵相关的安全漏洞；</p>
<p>5.做好相应的安全防护工作，以防再次感染。</p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>漏洞</tag>
        <tag>安全</tag>
      </tags>
  </entry>
  <entry>
    <title>招聘网站信息收集</title>
    <url>/2019/12/03/%E6%8B%9B%E8%81%98%E7%BD%91%E7%AB%99%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</url>
    <content><![CDATA[<h2 id="FindJob"><a href="#FindJob" class="headerlink" title="FindJob"></a>FindJob</h2><p> 爬取各大招聘公司，将招聘信息保存到本地。</p>
<a id="more"></a>
<h3 id="招聘网站"><a href="#招聘网站" class="headerlink" title="招聘网站"></a>招聘网站</h3><ul>
<li><a href="https://www.zhipin.com/" target="_blank" rel="noopener">BOSS直聘</a></li>
<li><a href="https://www.51job.com/" target="_blank" rel="noopener">前程无忧51Job</a></li>
<li><a href="https://www.zhaopin.com/" target="_blank" rel="noopener">智联招聘</a></li>
<li><a href="https://www.lagou.com/" target="_blank" rel="noopener">拉钩网</a></li>
</ul>
<p><strong>持续更新</strong></p>
<h3 id="传入参数设计"><a href="#传入参数设计" class="headerlink" title="传入参数设计"></a>传入参数设计</h3><p>由于这些招聘网站设置的参数不同，统一到本项目中设置两个参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">city: 招聘地点</span></pre></td></tr><tr><td class="code"><pre><span class="line">keyword: 搜索关键字（如：java、python、平面设计等等）</span></pre></td></tr></table></figure>
<p>同时可以选择其中一个网站获取数据，也可以获得所有网站进行数据获取。</p>
<h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><ul>
<li>core <pre><code>- boss.py         `boss直聘`
- QCWY.py       `前程无忧`
- zhilian.py        `智联招聘`</code></pre><ul>
<li>save-data     <code>存储数据</code></li>
<li>utils  <code>工具</code></li>
<li>config.py <code>配置</code></li>
<li>findjob.py <code>主文件</code></li>
</ul>
</li>
</ul>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>以<code>前程无忧</code>进行代码分析，定义一个<code>QCWY</code>类，构造函数只要传入关键字、城市名称、线程数。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14106334-9e9ae52db4571c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="URL分析"><br>通过分析url， 获得相应的信息，这里城市的ID比较难构造，但是通过分析其他文件发现一个JS文件，保存着城市ID和城市之间的关系，通过分析JS文件，将输入的城市名称转换成相应的ID：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_city_code</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    url = <span class="string">'https://js.51jobcdn.com/in/js/2016/layer/area_array_c.js'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    req = requests.get(url, headers=self.header).text</span></pre></td></tr><tr><td class="code"><pre><span class="line">    a = req.find(self.city)</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">return</span> req[a - <span class="number">9</span>:a - <span class="number">3</span>]</span></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/14106334-bd17de42e6679485.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="城市ID"></p>
<hr>
<p>同时获取搜索的页数，并构造相应URL<br><img src="https://upload-images.jianshu.io/upload_images/14106334-5c5647f0987300fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="获取最大页数"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_max_page</span><span class="params">(self)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        city_code = self._get_city_code()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        url = self.baseurl + <span class="string">'&#123;&#125;,000000,0000,00,9,99,&#123;&#125;,2,1.html'</span>.format(city_code, self.keyword)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        req = requests.get(url=url, headers=self.header)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        req.encoding = <span class="string">'gbk'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        html = etree.HTML(req.text)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        max_page = html.xpath(<span class="string">'//*[@id="resultList"]/div[2]/div[5]/text()'</span>)[<span class="number">1</span>][<span class="number">3</span>:]</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> range(<span class="number">1</span>, int(max_page) + <span class="number">1</span>):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            page_url = self.baseurl + <span class="string">'&#123;&#125;,000000,0000,00,9,99,&#123;&#125;,2,&#123;&#125;.html'</span>.format(city_code, self.keyword, page)</span></pre></td></tr><tr><td class="code"><pre><span class="line">            self.pagequeue.put(page_url)</span></pre></td></tr></table></figure>
<hr>
<p>进行上述获得城市ID，获得最大页码后，进行url构造后进行爬取，通过分析用Xpath就行获取相应的信息，获得如下信息</p>
<ol>
<li>职位名称</li>
<li>详细链接</li>
<li>公司名称</li>
<li>工作地点</li>
<li>薪资</li>
<li>发布时间</li>
<li>职位信息</li>
<li>公司信息</li>
</ol>
<p>获取这些字段，使用csv进行存储。</p>
<h4 id="存在问题"><a href="#存在问题" class="headerlink" title="存在问题"></a>存在问题</h4><ul>
<li>Boss直聘存在反爬，导致IP封禁。可以设置IP代理，最近得知正常Boss直聘增加了跳转，需要继续更新。</li>
<li>主文件中，多进程没有起作用，搜索之后，没有解决，请了解的小伙伴就行指教。</li>
</ul>
<h4 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h4><p><a href="[https://github.com/Joynice/FindJob](https://github.com/Joynice/FindJob)">FindJob</a><br>同时推荐给小伙伴我们团队的爬虫项目地址如下：<br><a href="https://github.com/DropsDevopsOrg/ECommerceCrawlers" target="_blank" rel="noopener">ECommerceCrawlers</a></p>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>百度关键词收录爬取</title>
    <url>/2019/12/03/%E7%99%BE%E5%BA%A6%E5%85%B3%E9%94%AE%E8%AF%8D%E6%94%B6%E5%BD%95%E7%88%AC%E5%8F%96/</url>
    <content><![CDATA[<hr>
<p>title: 百度关键词收录爬取<br>date: 2019-12-03 20:35:03<br>tags:</p>
<ul>
<li>爬虫<br>categories:</li>
<li>爬虫</li>
</ul>
<p>根据百度搜索，输入关键字，获取相应关键子的收录数。</p>
<a id="more"></a>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ol>
<li>根据百度搜索，输入关键词，获得相应关键词的收录数。</li>
<li>收集完数据后，根据指定的阈值进行数据分类（如大于收录数大于1000的保存在一个csv文件，其他保存在另一个csv文件中。）。</li>
<li>爬虫效率（目前测试实现18w/1h），带宽影响很大。</li>
<li>打包成exe，可执行文件。</li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><strong>接口</strong>：<a href="http://www.baidu.com/s" target="_blank" rel="noopener">http://www.baidu.com/s</a> </p>
<p><strong>传参</strong>：data = {‘wd’: 关键词}</p>
<p>由于百度这个接口没有反爬设置，所有正确访问即可，通过Xpath+re获得想要的数据。</p>
<p>具体爬取内容如图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/14106334-f9e08d54c97eafec.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="爬取内容"></p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>先将需要爬取的txt文件复制到“彩票关键词”目录，保证目录中只存在需要爬取的文件。</li>
<li>再打开数据采集器，设置线程数，以及阈值。线程数建议20，根据带宽决定；阈值将数据进行划分出大于该值以及小于该值的两个文件。</li>
<li>最后从结果文件夹中提取出爬取结果。</li>
</ol>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a><a href="https://github.com/DropsDevopsOrg/ECommerceCrawlers/tree/master/OthertCrawler/0x10baidu" target="_blank" rel="noopener">项目地址</a></h2><p><a href="https://github.com/DropsDevopsOrg/ECommerceCrawlers/tree/master/OthertCrawler/0x10baidu" target="_blank" rel="noopener">https://github.com/DropsDevopsOrg/ECommerceCrawlers/tree/master/OthertCrawler/0x10baidu</a></p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol>
<li>学习TK。</li>
<li>异步</li>
<li>优化保存。</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>高用代理</title>
    <url>/2019/12/03/%E9%AB%98%E7%94%A8%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<p>由于我们的代理有限，所以需要去一些代理网站上爬取一些可用的高效的代理，所以就需要爬虫去完成这部分的工作。</p>
<a id="more"></a>
<ol>
<li>爬虫部分  </li>
<li>代理检测  </li>
<li>存储</li>
</ol>
<h2 id="爬虫部分"><a href="#爬虫部分" class="headerlink" title="爬虫部分"></a>爬虫部分</h2><p>　　由于我们的代理有限，所以需要去一些代理网站上爬取一些可用的高效的代理，所以就需要爬虫去完成这部分的工作。</p>
<p>　　为了爬取高效的代理，找到以下的代理网站进行爬取：</p>
<ul>
<li><code>http://ip.kxdaili.com/</code></li>
<li><code>http://www.xicidaili.com/</code></li>
<li><code>http://www.66ip.cn/</code></li>
<li><code>http://www.66ip.cn/areaindex_%s/1.html</code></li>
<li><code>http://www.89ip.cn/</code></li>
</ul>
<p>　　首先，定义个爬虫类，我们只需传入爬取网站的url、正则表达式、以及标志符flag就可以调用get_data（）函数进行爬取，大大优化了代码结构，代码如下：  </p>
<pre><code>class Crawler(object):
    def __init__(self, url, regular, flag=None):
        self.url = url
        self.regular = regular
        self.flag = flag

    def get_data(self):
        proxies_list = []
        for i in self.url:
            print(i)
            try:
                text = requests.get(i, headers=config.HEADERS)
            except:
                pass
            time.sleep(5)
            text.encoding = &apos;utf-8&apos;
            data = re.findall(self.regular, text.text)
            if i[11:15] == &apos;66ip&apos;:
                for t in range(1, int(len(data) / self.flag)):
                    proxies = &apos;{}:{}&apos;.format(data[self.flag * t], data[(self.flag * t) + 1])
                    proxies_list.append(proxies)
            elif i[11:15] == &apos;89ip&apos;:
                proxies_list = data[1:]
            else:
                for t in range(0, int(len(data) / self.flag)):
                    proxies = &apos;{}:{}&apos;.format(data[self.flag * t], data[(self.flag * t) + 1])
                    proxies_list.append(proxies)
        return proxies_list</code></pre><p>　　代理列表如下：  </p>
<pre><code>SPIDER_PARSER_LIST =[
{    # 开心代理
    &apos;url&apos;:[&apos;http://ip.kxdaili.com/ipList/%s.html#ip&apos; % i for i in range(1, 11)],
    &apos;regular&apos;:&apos;&lt;td&gt;(.*?)&lt;/td&gt;&apos;,
    &apos;flag&apos;:7
},
{    # 西刺代理
    &apos;url&apos;:[&apos;http://www.xicidaili.com/nn/%s&apos; % i for i in range(1, 5)],
    &apos;regular&apos;:&apos;&lt;td&gt;(.*?)&lt;/td&gt;&apos;,
    &apos;flag&apos;:5
},
{    # 66ip代理-全国代理
    &apos;url&apos;: [&apos;http://www.66ip.cn/%s.html&apos; % i for i in range(1, 40)],
    &apos;regular&apos;: &apos;&lt;td&gt;(.*?)&lt;/td&gt;&apos;,
    &apos;flag&apos;:5
},
{    # 66ip代理-各省代理
    &apos;url&apos;: [&apos;http://www.66ip.cn/areaindex_%s/1.html&apos; % i for i in range(1, 35)],
    &apos;regular&apos;: &apos;&lt;td&gt;(.*?)&lt;/td&gt;&apos;,
    &apos;flag&apos;:5
},
{    # 根据api获得代理
    &apos;url&apos;: [&apos;http://www.89ip.cn/tqdl.html?api=1&amp;num={}&amp;port=&amp;address=&amp;isp=&apos;.format(500)],
    &apos;regular&apos;: &apos;(.*?)&lt;br&gt;&apos;,
    &apos;flag&apos;: None
},
]  </code></pre><p>　　调用方法如下：　　</p>
<pre><code>def get_object():
    proxise_list = []
    for pirder_paeser in config.SPIDER_PARSER_LIST:
        url = Crawler(url=pirder_paeser.get(&apos;url&apos;), regular=pirder_paeser.get(&apos;regular&apos;),
                      flag=pirder_paeser.get(&apos;flag&apos;)).get_data()
        proxise_list.append(url)
    return proxise_list</code></pre><h2 id="代理检测"><a href="#代理检测" class="headerlink" title="代理检测"></a>代理检测</h2><p>　　将存在列表里的代理组成一个新的列表，利用进程池进行快速地检测，检测主要如下：  </p>
<ol>
<li>代理是否可用，代理延迟大于3秒即视为不可用。  </li>
<li>http与https代理划分。  </li>
<li>高匿性检测（此部分完成的不好）。  </li>
</ol>
<p>　　由于自己的知识的欠缺，对于代理方面的知识了解不够全面，导致对于代理检测也是跟着自己的想法进行测试，不知道是否合理，请大家指出。代码如下：  </p>
<pre><code>def check(proxy):
    http_proxy_list = []
    http_proxy_gaoni_list = []
    https_proxy_list = []

    proxy_http_dict = {
        &apos;http&apos;: proxy
    }
    proxy_https_dict = {
        &apos;https&apos;: proxy
    }
    try:
        http_res = requests.get(config.SPIDER_PUBLIC_URL, proxies=proxy_http_dict, timeout=5,
                                headers=config.HEADERS)
        time.sleep(1)
        if http_res.status_code == 200:
            try:
                dic1 = eval(http_res.text)
                ip = dic1.get(&apos;remote_addr&apos;)
                if ip == public_network_ip:
                    http_proxy_list.append(proxy)
                    print(http_res.text)
                else:
                    print(http_res.text)
                    http_proxy_gaoni_list.append(proxy)
            except:
                pass
    except Exception as e:
        print(e)
    try:
        https_res = requests.get(&apos;https://www.baidu.com/&apos;, timeout=5, proxies=proxy_https_dict
                                 , headers=config.HEADERS, verify=False)
        time.sleep(1)
        if https_res.status_code == 200:
            print(&apos;https:&apos;)
            https_proxy_list.append(proxy)
    except Exception as e:
        print(e)
    print(http_proxy_list, http_proxy_gaoni_list, https_proxy_list)
    return http_proxy_list, http_proxy_gaoni_list, https_proxy_list</code></pre><h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p>　　利用python的flask-sqlalchemy模块进行关系到表的映射。Proxy结构如下：  </p>
<pre><code>class Proxy(db.Model):
    __tablename__ = &apos;proxy_pool&apos;
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    proxy = db.Column(db.String(100), nullable=False,unique=False)
    http = db.Column(db.String(100), nullable=False)
    type = db.Column(db.String(100), nullable=False)
    score = db.Column(db.Integer, nullable=False)
    add_time = db.Column(db.DateTime, nullable=False)
    check_time = db.Column(db.DateTime, nullable=False)
    res_time = db.Column(db.Float, nullable=False)</code></pre><p>　　存储是利用非orm结构进行存储，将检测的结果一次性存储，缩短了存储时间，减小了对数据库的压力。代码如下：  </p>
<pre><code>def save(proxy_list1, proxy_list2, proxy_list3):

    if len(proxy_list1) &gt; 0:
        session.execute(Proxy.__table__.insert(), [{&apos;proxy&apos;: str(i), &apos;http&apos;: &apos;http&apos;, &apos;type&apos;: &apos;透明&apos;, &apos;score&apos;: str(100)
                                                       , &apos;add_time&apos;: datetime.datetime.now(),
                                                    &apos;check_time&apos;: datetime.datetime.now()
                                                       , &apos;res_time&apos;: 0.1} for i in proxy_list1])
    else:
        pass
    if len(proxy_list2) &gt; 0:
        session.execute(Proxy.__table__.insert(), [
            {&apos;proxy&apos;: str(i), &apos;http&apos;: &apos;https&apos;, &apos;type&apos;: &apos;高匿&apos;, &apos;score&apos;: str(100), &apos;add_time&apos;: datetime.datetime.now(),
             &apos;check_time&apos;: datetime.datetime.now(), &apos;res_time&apos;: 0.1} for i in proxy_list2])
    else:
        pass
    if len(proxy_list3) &gt; 0:
        session.execute(Proxy.__table__.insert(), [
            {&apos;proxy&apos;: str(i), &apos;http&apos;: &apos;http&apos;, &apos;type&apos;: &apos;高匿&apos;, &apos;score&apos;: str(100), &apos;add_time&apos;: datetime.datetime.now(),
             &apos;check_time&apos;: datetime.datetime.now(), &apos;res_time&apos;: 0.1} for i in proxy_list3])
    else:
        pass
    session.commit()
    session.close()</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>　　第一次，合作完成项目，学习到了许多知识如：  </p>
<ol>
<li>利用类，充分利用代码，降低耦合度。</li>
<li>利用进程池缩短检测时间。</li>
<li>以及非orm存储数据库。  　　</li>
</ol>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>启发式爬虫</title>
    <url>/2019/12/03/%E5%90%AF%E5%8F%91%E5%BC%8F%E7%88%AC%E8%99%AB/</url>
    <content><![CDATA[<p>简而言之启发式爬虫是基于所有历史经验及曾经看到过的已知场景，通过分析这些场景和利用已知的经验构造并实现规则的爬虫。</p>
<a id="more"></a>


<ol>
<li>什么是启发式爬虫？</li>
<li>启发式爬虫好处</li>
<li>启发式爬虫具体实现</li>
</ol>
<h2 id="什么是启发式爬虫？"><a href="#什么是启发式爬虫？" class="headerlink" title="什么是启发式爬虫？"></a>什么是启发式爬虫？</h2><p>　　简而言之启发式爬虫是基于所有历史经验及曾经看到过的已知场景，通过分析这些场景和利用已知的经验构造并实现规则的爬虫。</p>
<h2 id="启发式爬虫好处"><a href="#启发式爬虫好处" class="headerlink" title="启发式爬虫好处"></a>启发式爬虫好处</h2><p>现今网站特征：　　　　</p>
<pre><code>1. Vue.js
2. JQuery
3. Handlebars
4. 代码混淆反爬虫
5. DOM时间频繁更新　　　　</code></pre><p>　　这些网站特征导致requests、urllib这些传统爬虫所用到的模块爬取不到有用的信息。这样，基于无界面的浏览器横空出世。 </p>
<p>　　无界面浏览器发展到现在，Chromium Headless可以说是众多浏览器中的佼佼者，一方面它是谷歌研发市场第一，几个小时一个版本更新，另一方面，Chromium Headless积极支持W3C标志组织。这些优势，势必会成为将来爬虫和自动化测试的利器。    </p>
<p>　　既然已经拥有了这么强大的无界面浏览器，就要用强大的工具去操纵它，puppteer翻译是操纵木偶的人，利用这个工具，我们能做到一个操纵页面的人。puppteer是一个Node.js的库，支持调用Chrome的Api来操纵web，相比较Selenium或是PhantomJs，它最大的特点就是它的操作Dom可以完成在内存中进行模拟既在V8引擎中处理而不打开浏览器，而且关键是这个是Chrome团队在维护，会拥有更好的兼容性和前景。   </p>
<p>　　Pyppteer是python中操作Chromium Headless的库，具有个puppteer一样的功能，如以下功能：    </p>
<pre><code>1. 利用网页生成PDF、图片
2. 爬取SPA应用，并生成预渲染内容（即“SSR” 服务端渲染）
3. 可以从网站抓取内容
4. 自动化表单提交、UI测试、键盘输入等
5. 帮你创建一个最新的自动化测试环境（chrome），可以直接在此运行测试用例
6. 捕获站点的时间线，以便追踪你的网站，帮助分析网站性能问题</code></pre><h2 id="启发式爬虫具体实现"><a href="#启发式爬虫具体实现" class="headerlink" title="启发式爬虫具体实现"></a>启发式爬虫具体实现</h2><p>　　首先可以把爬虫看作一个工厂流水线系统，流水线系统一定会有一个总队长负责各条生产线任务调度，在这里<font color=red size=2 face="Consolas">ROP</font>就是总队长。流程明确后，每个步骤都各司其职实现各自的功能。　　　　</p>
<p>　　爬虫总队长这个管理器的功能负责任务调度和事件管理。在做扫描器爬虫的第一步先将URL传给任务调度器总队长，总队长把这个任务传给下面，之后打开页面进入到加载状态。页面加载后需要判断当前页面是否完全，比如有时候某些网页服务器网络性差，或是遇到GS报错、网站超时某些资源显示不全，这时候可以通过下图标注的三个状态来确定整个网页的结构是否加载完成，整个页面是否打开完成。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/14106334-07cca1feae006adf?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="启发式爬虫具体实现"></p>
<p>　　完成后把整个浏览器page页面锁定不做任何动作，让它打开另外一个新网页，或者跳转其他网页上去。</p>
<p>　　当整个网页加载好之后，把整个网页跳转锁定后就可以进入到函数劫持阶段。随后开始注入一个监听器，监听所有事件的变动和事件触发的信息。当文件加载、函数劫持、监听都完成之后，可以编译出任何输入框绑定的事件，对某个输入参数值进行常规判断的一些信息。</p>
<p>　　当我们发现页面存在表单的时候，可以通过分析表单的输入类型以及表单名称，进行一些参数填充。上面所有流程结束后，会得到当前页面所有信息的结果题。此时可以通过去虫过滤之后，返回给事件管理器，重复执行整个流程。</p>
<p>　　确定总体流程之后回到刚才的第一步，页面加载，录入实现。</p>
<p>　　当一个页面加载完成之后，应该在什么时候注入我们的劫持代码，这里边有状态可以选择。第一个在page load之后；第二个是等待页面加载完成之后，也就是当前网络状态全部空闲的时候，整个爬虫执行流再继续执行；或者判断整个网页的DOM树是否被加载并解析完成。</p>
<h3 id="演示实例"><a href="#演示实例" class="headerlink" title="演示实例"></a>演示实例</h3><p>Example: open web page and take a screenshot.</p>
<pre><code>import asyncio
from pyppeteer import launch

async def main():
    browser = await launch()
    page = await browser.newPage()
    await page.goto(&apos;http://example.com&apos;)
    await page.screenshot({&apos;path&apos;: &apos;example.png&apos;})
    await browser.close()

asyncio.get_event_loop().run_until_complete(main())</code></pre><p>Example: evaluate script on the page.</p>
<pre><code>import asyncio
from pyppeteer import launch

async def main():
    browser = await launch()
    page = await browser.newPage()
    await page.goto(&apos;http://example.com&apos;)
    await page.screenshot({&apos;path&apos;: &apos;example.png&apos;})

    dimensions = await page.evaluate(&apos;&apos;&apos;() =&gt; {
        return {
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientHeight,
            deviceScaleFactor: window.devicePixelRatio,
        }
    }&apos;&apos;&apos;)

    print(dimensions)
    # &gt;&gt;&gt; {&apos;width&apos;: 800, &apos;height&apos;: 600, &apos;deviceScaleFactor&apos;: 1}
    await browser.close()

asyncio.get_event_loop().run_until_complete(main())</code></pre>]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>Pyppteer</tag>
      </tags>
  </entry>
</search>
